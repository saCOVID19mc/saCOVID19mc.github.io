#Code developed by Modelling and Simulation Hub, Africa (MASHA) www.masha.uct.ac.za for the South African COVID-19 Modelling Consortium (SACMC)
#Key Features: Age structure, Multi-strain, Sub-populations (Heath care workers, Co-morbidities, Everyone else), Vaccination
#Granularity: Provincial  
#Disease: COVID-19
#Time Frame (Data): 2020-10-01 - 2024-12-31

#Note: Owing to restrictions on publishing data owned by the government of South Africa, this code will not run to reproduce output generated by the SACMC.
#Note: This code will not run and a simulation dataset will be developed in the future. 

#### Install and load packages####
library(pacman)
p_load(tidyverse, 
       crayon, 
       adaptivetau, 
       deSolve, 
       diffeqr, 
       ggplot2, 
       zoo, 
       glue, 
       readxl, 
       openxlsx, 
       EnvStats, 
       JuliaCall, 
       argparser, 
       doParallel, 
       data.table, 
       lubridate, 
       gridExtra
)



#### Set working directory ####
setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) # set wd to source file

system("R CMD SHLIB eq0.c")     # compiles c code
dyn.load("eq0.so")              # loads compiled code to memory (.so - OS X, .dll - Windows)

#### Model Start up definitions####
N<-3   # number of subpopulations 1: HCW, 2: CM, 3: EE
G<-7  #number of age groups 
B<-53   # number of variables per patch
A<-169  # number of transitions per patch
V<-N*G*B # total number of variables
L<-N*G*A #total number of transitions
sday<-1
startyear=sday/365 # starting year of simulation 0=2020-10-01
startdate = as.Date("2020-10-01")
tyears<-4.5*365/365 # total years of simulation 
dtout<-1/365 # output timestep
tsteps<-floor(tyears/dtout) # number of time steps
time<-startyear+seq(0,tyears,dtout) # time vector

# Call C function from eq0.so in R
EQ<-function(L, N, oldeq, transit,transitionsiu1,transitionsiu2,transitionsiv1,transitionsiv2){
  len<-length(oldeq)
  .C("EQ",
     as.integer(L),
     as.integer(N),
     as.double(oldeq),
     as.double(transit),
     as.integer(transitionsiu1),
     as.integer(transitionsiu2),
     as.integer(transitionsiv1),
     as.integer(transitionsiv2),
     as.double(vector("double",length = len))
  )[[9]]
  
}

#### Import data ####
# ************************************************************************************* #
#Cannot source unpublished data


# ************************************************************************************* #
#### Define variables ####
# ************************************************************************************* #
# COVID-19

# 1= S         Uninfected non-immune
# 2= E1        Wild:infected & exposed
# 3= Iam1      Wild:asymptomatic or mild and infectious
# 4= Ip1:      Wild:pre-symptomatic and infectious 
# 5= IsnotT1:  Wild:severe, destined to be untreated and infectious
# 6= Ist1:     Wild:severe, destined to be treated and infectious
# 7= H1:       Wild:severe treated in general bed 
# 8= ICU1:     Wild:severe entry in ICU bed 
# 9= R1:       Wild:removed from infectious stage  
# 10=Er1:      Wild:infected & exposed with natural immunity
# 11=D:        Dead

# 12=E2:       New:infected & exposed
# 13=Iam2:     New:asymptomatic or mild and infectious
# 14=Ip2:      New:pre-symptomatic and infectious 
# 15=IsnotT2:  New:severe, destined to be untreated and infectious
# 16=Ist2:     New:severe, destined to be treated and infectious
# 17=H2:       New:severe treated in general bed 
# 18=ICU2:     New:severe entry in ICU bed 
# 19=R2:       New:removed from infectious stage  
# 20=Er2:      New:infected & exposed with natural immunity

# 21=VP1_S:    Pfizer: 1st dose on Susceptible (Protected)
# 22=VPnot1_S: Pfizer: 1st dose on Susceptible (Not Protected)
# 23=VP1_R:    Pfizer: 1st dose on Recovered (Protected)
# 24=VPnot1_R: Pfizer: 1st dose on Recovered (Not Protected)
# 25=VP2_S:    Pfizer: 2nd dose on Susceptible (Protected)
# 26=VPnot2_S: Pfizer: 2nd dose on Susceptible (Not Protected)
# 27=VP2_R:    Pfizer: 2nd dose on Recovered (Protected)
# 28=VPnot2_R: Pfizer: 2nd dose on Recovered (Not Protected)
# 29=VJ_S:     JnJ: on Susceptible (Protected)
# 30=VJnot_S:  JnJ: on Susceptible (Not Protected)
# 31=VJ_R:     JnJ: on Recovered (Protected)
# 32=VJnot_R:  JnJ: on Recovered (Not Protected)
# 33=FV_P1:    Counter: Pfizer first dose (actual)
# 34=FV_P2:    Counter: Pfizer second dose (actual)
# 35=FV_J:     Counter: JnJ first dose (actual)
# 36=VP3_S:    Pfizer: 3rd dose on Susceptible (Protected)
# 37=VPnot3_S: Pfizer: 3rd dose on Susceptible (Not Protected)
# 38=VP3_R:    Pfizer: 3rd dose on Recovered (Protected)
# 39=VPnot3_R: Pfizer: 3rd dose on Recovered (Not Protected)
# 40=VJ2_S:    JnJ: 2nd dose on Susceptible (Protected)
# 41=VJnot2_S: JnJ: 2nd dose on Susceptible (Not Protected)
# 42=VJ2_R:    JnJ: 2nd dose on Recovered (Protected)
# 43=VJnot2_R: JnJ: 2nd dose on Recovered (Not Protected)
# 44=FV_P3:    Counter: Pfizer third dose (actual)
# 45=FV_J2:    Counter: JnJ second dose (actual)
# 46=IPam1:    Wild:asymptomatic or mild and infectious for Pfizer Vaccinated
# 47=IPp1:     Wild:pre-symptomatic and infectious for Pfizer Vaccinated
# 48=IPam2:    New:asymptomatic or mild and infectious for Pfizer Vaccinated
# 49=IPp2:     New:pre-symptomatic and infectious for Pfizer Vaccinated
# 50=IJam1:    Wild:asymptomatic or mild and infectious for JnJ Vaccinated
# 51=IJp1:     Wild:pre-symptomatic and infectious for JnJ Vaccinated
# 52=IJam2:    New:asymptomatic or mild and infectious for JnJ Vaccinated
# 53=IJp2:     New:pre-symptomatic and infectious for JnJ Vaccinated

covpop<-c(1:10, 12:32, 36:43, 46:53) #alive


#Define state names for solver 
getStates <- function(x) {
  for (n in 1:N){
    for (g in 1:G){
      popc[g,n]<-sum(x[varind[covpop,g,n]])  
    }
  }
  
  states <- list(
    .S = array(x[varind[1,,]], dim=c(G,N)),
    .E1 = array(x[varind[2,,]], dim=c(G,N)),
    .Iam1 = array(x[varind[3,,]], dim=c(G,N)),
    .Ip1 = array(x[varind[4,,]], dim=c(G,N)),
    .IsnotT1 = array(x[varind[5,,]], dim=c(G,N)),
    .Ist1 = array(x[varind[6,,]], dim=c(G,N)),
    .H1 = array(x[varind[7,,]], dim=c(G,N)),
    .ICU1 = array(x[varind[8,,]], dim=c(G,N)),
    .R1 = array(x[varind[9,,]], dim=c(G,N)),
    .Er1 = array(x[varind[10,,]], dim=c(G,N)),
    .D = array(x[varind[11,,]], dim=c(G,N)),
    .E2 = array(x[varind[12,,]], dim=c(G,N)),
    .Iam2 = array(x[varind[13,,]], dim=c(G,N)),
    .Ip2 = array(x[varind[14,,]], dim=c(G,N)),
    .IsnotT2 = array(x[varind[15,,]], dim=c(G,N)),
    .Ist2 = array(x[varind[16,,]], dim=c(G,N)),
    .H2 = array(x[varind[17,,]], dim=c(G,N)),
    .ICU2 = array(x[varind[18,,]], dim=c(G,N)),
    .R2 = array(x[varind[19,,]], dim=c(G,N)),
    .Er2 = array(x[varind[20,,]], dim=c(G,N)),
    .VP1_S = array(x[varind[21,,]], dim=c(G,N)),
    .VPnot1_S = array(x[varind[22,,]], dim=c(G,N)),
    .VP1_R = array(x[varind[23,,]], dim=c(G,N)),
    .VPnot1_R = array(x[varind[24,,]], dim=c(G,N)),
    .VP2_S = array(x[varind[25,,]], dim=c(G,N)),
    .VPnot2_S = array(x[varind[26,,]], dim=c(G,N)),
    .VP2_R = array(x[varind[27,,]], dim=c(G,N)),
    .VPnot2_R = array(x[varind[28,,]], dim=c(G,N)),
    .VJ_S = array(x[varind[29,,]], dim=c(G,N)),
    .VJnot_S = array(x[varind[30,,]], dim=c(G,N)),
    .VJ_R = array(x[varind[31,,]], dim=c(G,N)),
    .VJnot_R = array(x[varind[32,,]], dim=c(G,N)),
    .FV_P1 = array(x[varind[33,,]], dim=c(G,N)),
    .FV_P2 = array(x[varind[34,,]], dim=c(G,N)),
    .FV_J= array(x[varind[35,,]], dim=c(G,N)),
    .VP3_S = array(x[varind[36,,]], dim=c(G,N)),
    .VPnot3_S = array(x[varind[37,,]], dim=c(G,N)),
    .VP3_R = array(x[varind[38,,]], dim=c(G,N)),
    .VPnot3_R = array(x[varind[39,,]], dim=c(G,N)),
    .VJ2_S = array(x[varind[40,,]], dim=c(G,N)),
    .VJnot2_S = array(x[varind[41,,]], dim=c(G,N)),
    .VJ2_R = array(x[varind[42,,]], dim=c(G,N)),
    .VJnot2_R = array(x[varind[43,,]], dim=c(G,N)),
    .FV_P3 = array(x[varind[44,,]], dim=c(G,N)),
    .FV_J2= array(x[varind[45,,]], dim=c(G,N)),
    .IPam1= array(x[varind[46,,]], dim=c(G,N)),
    .IPp1= array(x[varind[47,,]], dim=c(G,N)),
    .IPam2= array(x[varind[48,,]], dim=c(G,N)),
    .IPp2= array(x[varind[49,,]], dim=c(G,N)),
    .IJam1= array(x[varind[50,,]], dim=c(G,N)),
    .IJp1= array(x[varind[51,,]], dim=c(G,N)),
    .IJam2= array(x[varind[52,,]], dim=c(G,N)),
    .IJp2= array(x[varind[53,,]], dim=c(G,N)),
    .pop = popc
    
  )
  return(states)
}


# ************************************************************************************* #
#### Define transitions ####
# ************************************************************************************* #
varind<-array(1:(B*G*N),c(B,G,N))
traind<-array(1:(A*G*N),c(A,G,N))

# ************************************************************************************* #
# define transitions
# ************************************************************************************* #
transitions<-matrix(0,A*G*N, 4 )
#Transitions structure: c(exit compt number, exit coefficient, entry compt, entry coefficient)
for (n in 1:N){
  for (g in 1:G){
    count<-1
    #Incidence
    transitions[traind[count,g,n],]<-c(varind[1,g,n], -1,varind[2,g,n],+1); count<-count+1 # 1. incidence S to E1      
    transitions[traind[count,g,n],]<-c(varind[2,g,n], -1,varind[3,g,n],+1); count<-count+1 # 2. incubation E1 to Iam1  
    transitions[traind[count,g,n],]<-c(varind[2,g,n], -1,varind[4,g,n],+1); count<-count+1 # 3. incubation E1 to Ip1  
    transitions[traind[count,g,n],]<-c(varind[4,g,n], -1,varind[5,g,n],+1); count<-count+1 # 4. untreated severe infection Ip1 to IsnotT1
    transitions[traind[count,g,n],]<-c(varind[4,g,n], -1,varind[6,g,n],+1); count<-count+1 # 5. treated severe infection Ip1 to Ist1
    transitions[traind[count,g,n],]<-c(varind[6,g,n], -1,varind[7,g,n],+1); count<-count+1 # 6. hosp severe Ist1 to H1
    transitions[traind[count,g,n],]<-c(varind[6,g,n], -1,varind[8,g,n],+1); count<-count+1 # 7. hosp critical infection Ist1 to ICU1   
    #Recovery
    transitions[traind[count,g,n],]<-c(varind[3,g,n], -1,varind[9,g,n],+1); count<-count+1 # 8. natural recovery Iam1 to R1
    transitions[traind[count,g,n],]<-c(varind[5,g,n], -1,varind[9,g,n],+1); count<-count+1 # 9. natural recovery IsnotT1 to R1 
    transitions[traind[count,g,n],]<-c(varind[5,g,n], -1,varind[11,g,n],+1); count<-count+1 # 10. death IsnotT1 to D
    transitions[traind[count,g,n],]<-c(varind[7,g,n], -1,varind[9,g,n],+1); count<-count+1 # 11. severe discharged H1 to R1
    transitions[traind[count,g,n],]<-c(varind[7,g,n], -1,varind[11,g,n],+1); count<-count+1 # 12. severe died H1 to D
    transitions[traind[count,g,n],]<-c(varind[8,g,n], -1,varind[9,g,n],+1); count<-count+1 # 13. critical discharged ICU1 to R1
    transitions[traind[count,g,n],]<-c(varind[8,g,n], -1,varind[11,g,n],+1); count<-count+1 # 14. critical died ICU1 to D
    #Reinfection
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[10,g,n],+1); count<-count+1 # 15. reinfection R1 -> Er1
    transitions[traind[count,g,n],]<-c(varind[10,g,n], -1,varind[3,g,n],+1); count<-count+1 # 16. incubation Er1 to Iam1
    transitions[traind[count,g,n],]<-c(varind[10,g,n], -1,varind[4,g,n],+1); count<-count+1 # 17. incubation Er1 to Ip1
    
    #New Lineage
    #Incidence
    transitions[traind[count,g,n],]<-c(varind[1,g,n], -1,varind[12,g,n],+1); count<-count+1 # 18. incidence S to E2     
    transitions[traind[count,g,n],]<-c(varind[12,g,n], -1,varind[13,g,n],+1); count<-count+1 # 19. incubation E2 to Iam2   
    transitions[traind[count,g,n],]<-c(varind[12,g,n], -1,varind[14,g,n],+1); count<-count+1 # 20. incubation E2 to Ip2 
    transitions[traind[count,g,n],]<-c(varind[14,g,n], -1,varind[15,g,n],+1); count<-count+1 # 21. untreated severe infection Ip2 to IsnotT2 
    transitions[traind[count,g,n],]<-c(varind[14,g,n], -1,varind[16,g,n],+1); count<-count+1 # 22. treated severe infection Ip2 to Ist2 
    transitions[traind[count,g,n],]<-c(varind[16,g,n], -1,varind[17,g,n],+1); count<-count+1 # 23. hosp severe Ist2 to H2  
    transitions[traind[count,g,n],]<-c(varind[16,g,n], -1,varind[18,g,n],+1); count<-count+1 # 24. hosp critical infection Ist2 to ICU2   
    #Recovery
    transitions[traind[count,g,n],]<-c(varind[13,g,n], -1,varind[19,g,n],+1); count<-count+1 # 25. natural recovery Iam2 to R2   
    transitions[traind[count,g,n],]<-c(varind[15,g,n], -1,varind[19,g,n],+1); count<-count+1 # 26. natural recovery IsnotT2 to R2
    transitions[traind[count,g,n],]<-c(varind[15,g,n], -1,varind[11,g,n],+1); count<-count+1 # 27. death IsnotT2 to D
    transitions[traind[count,g,n],]<-c(varind[17,g,n], -1,varind[19,g,n],+1); count<-count+1 # 28. severe discharged H2 to R2  
    transitions[traind[count,g,n],]<-c(varind[17,g,n], -1,varind[11,g,n],+1); count<-count+1 # 29. severe died H2 to D
    transitions[traind[count,g,n],]<-c(varind[18,g,n], -1,varind[19,g,n],+1); count<-count+1 # 30. critical discharged ICU2 to R2
    transitions[traind[count,g,n],]<-c(varind[18,g,n], -1,varind[11,g,n],+1); count<-count+1 # 31. critical died ICU2 to D
    #Reinfection
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[20,g,n],+1); count<-count+1 # 32. reinfection R2 -> Er2
    transitions[traind[count,g,n],]<-c(varind[20,g,n], -1,varind[13,g,n],+1); count<-count+1 # 33. incubation Er2 to Iam2
    transitions[traind[count,g,n],]<-c(varind[20,g,n], -1,varind[14,g,n],+1); count<-count+1 # 34. incubation Er2 to Ip2 
    
    #Cross Infection
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[20,g,n],+1); count<-count+1 # 35. reinfection R1 -> Er2 
    
    #Vaccination
    #Pfizer vaccination
    transitions[traind[count,g,n],]<-c(varind[1,g,n], -1,varind[21,g,n],+1); count<-count+1 # 36. Pfizer: Susceptible given first vaccine and protected S -> VP1_S
    transitions[traind[count,g,n],]<-c(varind[1,g,n], -1,varind[22,g,n],+1); count<-count+1 # 37. Pfizer: Susceptible given first vaccine and not protected S -> VPnot1_S
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[23,g,n],+1); count<-count+1 # 38. Pfizer: Wild: Removed given first vaccine and protected by vaccine and prior infection R1 -> VP1_R
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[24,g,n],+1); count<-count+1 # 39. Pfizer: Wild: Removed given first vaccine and not protected by vaccine or prior infection R1 -> VPnot1_R
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[23,g,n],+1); count<-count+1 # 40. Pfizer: NL: Removed given first vaccine and protected by vaccine and prior infection R2 -> VP1_R
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[24,g,n],+1); count<-count+1 # 41.  Pfizer: NL: Removed given first vaccine and not protected by vaccine or prior infection R2 -> VPnot1_R
    transitions[traind[count,g,n],]<-c(varind[21,g,n], -1,varind[25,g,n],+1); count<-count+1 # 42. Pfizer: Susceptible Protected Vaccinated get second dose (remain protected) VP1_S -> VP2_S
    transitions[traind[count,g,n],]<-c(varind[23,g,n], -1,varind[27,g,n],+1); count<-count+1 # 43. Pfizer: removed Protected Vaccinated get second dose (remain protected) VP1_R -> VP2_R
    transitions[traind[count,g,n],]<-c(varind[22,g,n], -1,varind[25,g,n],+1); count<-count+1 # 44. Pfizer: Susceptible UnProtected Vaccinated get second dose (get protected) VPnot1_S -> VP2_S
    transitions[traind[count,g,n],]<-c(varind[22,g,n], -1,varind[26,g,n],+1); count<-count+1 # 45. Pfizer: Susceptible UnProtected Vaccinated get second dose (not protected) VPnot1_S -> VPnot2_S
    transitions[traind[count,g,n],]<-c(varind[24,g,n], -1,varind[27,g,n],+1); count<-count+1 # 46. Pfizer: removed UnProtected Vaccinated get second dose (get protected) VPnot1_R -> VP2_R
    transitions[traind[count,g,n],]<-c(varind[24,g,n], -1,varind[28,g,n],+1); count<-count+1 # 47. Pfizer: removed UnProtected Vaccinated get second dose (not protected) VPnot1_R -> VPnot2_R
    #JnJ vaccination
    transitions[traind[count,g,n],]<-c(varind[1,g,n], -1,varind[29,g,n],+1); count<-count+1 # 48. JJ: Susceptible given first vaccine and protected S -> VJ_S
    transitions[traind[count,g,n],]<-c(varind[1,g,n], -1,varind[30,g,n],+1); count<-count+1 # 49. JJ: Susceptible given first vaccine and not protected S -> VJnot_S
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[31,g,n],+1); count<-count+1 # 50. JJ: Wild: Removed given first vaccine and protected by vaccine and prior infection R1 -> VJ_R
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[32,g,n],+1); count<-count+1 # 51. JJ: Wild: Removed given first vaccine and not protected by vaccine or prior infection R1 -> VJnot_R
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[31,g,n],+1); count<-count+1 # 52. JJ: NL: Removed given first vaccine and protected by vaccine and prior infection R2 -> VJ_R
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[32,g,n],+1); count<-count+1 # 53.  JJ: NL: Removed given first vaccine and not protected by vaccine or prior infection R2 -> VJnot_R
    #vaccine waning (protection from infection)
    transitions[traind[count,g,n],]<-c(varind[21,g,n], -1,varind[22,g,n],+1); count<-count+1 # 54. Pfizer: Susceptible Vaccine waning (1st dose) VP1_S -> VPnot1_S
    transitions[traind[count,g,n],]<-c(varind[23,g,n], -1,varind[24,g,n],+1); count<-count+1 # 55. Pfizer: Removed Vaccine waning (1st dose) VP1_R -> VPnot1_R
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[26,g,n],+1); count<-count+1 # 56. Pfizer: Susceptible Vaccine waning (2nd dose) VP2_S -> VPnot2_S
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[28,g,n],+1); count<-count+1 # 57. Pfizer: Removed Vaccine waning (2nd dose) VP2_R -> VPnot2_R
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[26,g,n],+1); count<-count+1 # 58. JJ: Susceptible Vaccine waning (1st dose) VJ_S -> VJnot_S
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[28,g,n],+1); count<-count+1 # 59. JJ: Removed Vaccine waning (1st dose) VJ_R -> VJnot_R
    #Breakthrough infections
    #from Pfizer 1st dose
    transitions[traind[count,g,n],]<-c(varind[22,g,n], -1,varind[46,g,n],+1); count<-count+1 # 60. Pfizer Susceptible dose 1 Wild: Breakthrough infections: VPnot1_S -> IPam1
    transitions[traind[count,g,n],]<-c(varind[22,g,n], -1,varind[47,g,n],+1); count<-count+1 # 61. Pfizer Susceptible dose 1 Wild: Breakthrough infections: VPnot1_S -> IPp1
    transitions[traind[count,g,n],]<-c(varind[24,g,n], -1,varind[46,g,n],+1); count<-count+1 # 62. Pfizer Removed dose 1 Wild: Breakthrough infections: VPnot1_R -> IPam1
    transitions[traind[count,g,n],]<-c(varind[24,g,n], -1,varind[47,g,n],+1); count<-count+1 # 63. Pfizer Removed dose 1 Wild: Breakthrough infections: VPnot1_R -> IPp1
    transitions[traind[count,g,n],]<-c(varind[22,g,n], -1,varind[48,g,n],+1); count<-count+1 # 64. Pfizer Susceptible dose 1 NL: Breakthrough infections: VPnot1_S -> IPam2
    transitions[traind[count,g,n],]<-c(varind[22,g,n], -1,varind[49,g,n],+1); count<-count+1 # 65. Pfizer Susceptible dose 1 NL: Breakthrough infections: VPnot1_S -> IPp2
    transitions[traind[count,g,n],]<-c(varind[24,g,n], -1,varind[48,g,n],+1); count<-count+1 # 66. Pfizer Removed dose 1 NL: Breakthrough infections: VPnot1_R -> IPam2
    transitions[traind[count,g,n],]<-c(varind[24,g,n], -1,varind[49,g,n],+1); count<-count+1 # 67. Pfizer Removed dose 1 NL: Breakthrough infections: VPnot1_R -> IPp2
    #from Pfizer 2nd dose
    transitions[traind[count,g,n],]<-c(varind[26,g,n], -1,varind[46,g,n],+1); count<-count+1 # 68. Pfizer Susceptible dose 2 Wild: Breakthrough infections: VPnot2_S -> IPam1
    transitions[traind[count,g,n],]<-c(varind[26,g,n], -1,varind[47,g,n],+1); count<-count+1 # 69. Pfizer Susceptible dose 2 Wild: Breakthrough infections: VPnot2_S -> IPp1
    transitions[traind[count,g,n],]<-c(varind[28,g,n], -1,varind[46,g,n],+1); count<-count+1 # 70. Pfizer Removed dose 2 Wild: Breakthrough infections: VPnot2_R -> IPam1
    transitions[traind[count,g,n],]<-c(varind[28,g,n], -1,varind[47,g,n],+1); count<-count+1 # 71. Pfizer Removed dose 2 Wild: Breakthrough infections: VPnot2_R -> IPp1
    transitions[traind[count,g,n],]<-c(varind[26,g,n], -1,varind[48,g,n],+1); count<-count+1 # 72. Pfizer Susceptible dose 2 NL: Breakthrough infections: VPnot2_S -> IPam2
    transitions[traind[count,g,n],]<-c(varind[26,g,n], -1,varind[49,g,n],+1); count<-count+1 # 73. Pfizer Susceptible dose 2 NL: Breakthrough infections: VPnot2_S -> IPp2
    transitions[traind[count,g,n],]<-c(varind[28,g,n], -1,varind[48,g,n],+1); count<-count+1 # 74. Pfizer Removed dose 2 NL: Breakthrough infections: VPnot2_R -> IPam2
    transitions[traind[count,g,n],]<-c(varind[28,g,n], -1,varind[49,g,n],+1); count<-count+1 # 75. Pfizer Removed dose 2 NL: Breakthrough infections: VPnot2_R -> IPp2
    #JnJ
    transitions[traind[count,g,n],]<-c(varind[30,g,n], -1,varind[50,g,n],+1); count<-count+1 # 76. JJ Susceptible dose 1 Wild: Breakthrough infections: VJnot_S -> IJam1
    transitions[traind[count,g,n],]<-c(varind[30,g,n], -1,varind[51,g,n],+1); count<-count+1 # 77. JJ Susceptible dose 1 Wild: Breakthrough infections: VJnot_S -> IJp1
    transitions[traind[count,g,n],]<-c(varind[32,g,n], -1,varind[50,g,n],+1); count<-count+1 # 78. JJ Removed dose 1 Wild: Breakthrough infections: VJnot_R -> IJam1
    transitions[traind[count,g,n],]<-c(varind[32,g,n], -1,varind[51,g,n],+1); count<-count+1 # 79. JJ Removed dose 1 Wild: Breakthrough infections: VJnot_R -> IJp1
    transitions[traind[count,g,n],]<-c(varind[30,g,n], -1,varind[52,g,n],+1); count<-count+1 # 80. JJ Susceptible dose 1 NL: Breakthrough infections: VJnot_S -> IJam2
    transitions[traind[count,g,n],]<-c(varind[30,g,n], -1,varind[53,g,n],+1); count<-count+1 # 81. JJ Susceptible dose 1 NL: Breakthrough infections: VJnot_S -> IJp2
    transitions[traind[count,g,n],]<-c(varind[32,g,n], -1,varind[52,g,n],+1); count<-count+1 # 82. JJ Removed dose 1 NL: Breakthrough infections: VJnot_R -> IJam2
    transitions[traind[count,g,n],]<-c(varind[32,g,n], -1,varind[53,g,n],+1); count<-count+1 # 83. JJ Removed dose 1 NL: Breakthrough infections: VJnot_R -> IJp2
    #Seed new lineage
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[12,g,n],+1); count<-count+1 # 84. NL: Seed  -> E2
    # Deaths after discharge 
    transitions[traind[count,g,n],]<-c(varind[8,g,n], -1,varind[11,g,n],+1); count<-count+1 # 85. Wild: death after ICU discharge ICU1 -> D
    transitions[traind[count,g,n],]<-c(varind[18,g,n], -1,varind[11,g,n],+1); count<-count+1 # 86 NL: death after ICU discharge ICU2 -> D
    #counter: Symptomatic incidence
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[2,g,n],0); count<-count+1 # 87. Wild: All Symptomatic incidence
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[12,g,n],0); count<-count+1 # 88. NL: All Symptomatic incidence
    #Seed Delta lineage
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[2,g,n],+1); count<-count+1 # 89. Delta: Seed  -> E1
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[10,g,n],+1); count<-count+1 # 90. reinfection R2 -> Er1 
    #counter: actual vaccination counts
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[33,g,n],+1); count<-count+1 # 91. Pfizer dose 1: actual vaccination to FV_P1
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[34,g,n],+1); count<-count+1 # 92. Pfizer dose 2: actual vaccination to FV_P2
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[35,g,n],+1); count<-count+1 # 93. JnJ dose 1: actual vaccination to FV_J
    # Immune Escape Variant
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[12,g,n],+1); count<-count+1 # 94. IEvariant: Seed  -> E2
    transitions[traind[count,g,n],]<-c(varind[19,g,n], -1,varind[9,g,n],+1); count<-count+1 # 95. IEvariant: R2  -> R1
    transitions[traind[count,g,n],]<-c(varind[21,g,n], -1,varind[48,g,n],+1); count<-count+1 # 96. IEvariant: Pfizer Susceptible dose 1 NL: Breakthrough infections: VP1_S -> IPam2
    transitions[traind[count,g,n],]<-c(varind[21,g,n], -1,varind[49,g,n],+1); count<-count+1 # 97. IEvariant: Pfizer Susceptible dose 1 NL: Breakthrough infections: VP1_S -> IPp2
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[48,g,n],+1); count<-count+1 # 98. IEvariant: Pfizer Susceptible dose 2 NL: Breakthrough infections: VP2_S -> IPam2
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[49,g,n],+1); count<-count+1 # 99. IEvariant: Pfizer Susceptible dose 2 NL: Breakthrough infections: VP2_S -> IPp2
    transitions[traind[count,g,n],]<-c(varind[29,g,n], -1,varind[52,g,n],+1); count<-count+1 # 100. IEvariant: JJ Susceptible dose 1 NL: Breakthrough infections: VJ_S -> IJam2
    transitions[traind[count,g,n],]<-c(varind[29,g,n], -1,varind[53,g,n],+1); count<-count+1 # 101. IEvariant: JJ Susceptible dose 1 NL: Breakthrough infections: VJ_S -> IJp2
    
    transitions[traind[count,g,n],]<-c(varind[23,g,n], -1,varind[48,g,n],+1); count<-count+1 # 102. IEvariant: Pfizer Recovered dose 1 NL: Breakthrough infections: VP1_R -> IPam2
    transitions[traind[count,g,n],]<-c(varind[23,g,n], -1,varind[49,g,n],+1); count<-count+1 # 103. IEvariant: Pfizer Recovered dose 1 NL: Breakthrough infections: VP1_R -> IPp2
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[48,g,n],+1); count<-count+1 # 104. IEvariant: Pfizer Recovered dose 2 NL: Breakthrough infections: VP2_R -> IPam2
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[49,g,n],+1); count<-count+1 # 105. IEvariant: Pfizer Recovered dose 2 NL: Breakthrough infections: VP2_R -> IPp2
    transitions[traind[count,g,n],]<-c(varind[31,g,n], -1,varind[52,g,n],+1); count<-count+1 # 106. IEvariant: JJ Recovered dose 1 NL: Breakthrough infections: VJ_R -> IJam2
    transitions[traind[count,g,n],]<-c(varind[31,g,n], -1,varind[53,g,n],+1); count<-count+1 # 107. IEvariant: JJ Recovered dose 1 NL: Breakthrough infections: VJ_R -> IJp2
    
    ##Booster dose
    #get vaccinated
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[36,g,n],+1); count<-count+1 # 108. Pfizer: Susceptible Protected Vaccinated get third dose (remain protected) VP2_S -> VP3_S
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[38,g,n],+1); count<-count+1 # 109. Pfizer: removed Protected Vaccinated get third dose (remain protected) VP2_R -> VP3_R
    transitions[traind[count,g,n],]<-c(varind[26,g,n], -1,varind[36,g,n],+1); count<-count+1 # 110. Pfizer: Susceptible UnProtected Vaccinated get third dose (get protected) VPnot2_S -> VP3_S
    transitions[traind[count,g,n],]<-c(varind[26,g,n], -1,varind[37,g,n],+1); count<-count+1 # 111. Pfizer: Susceptible UnProtected Vaccinated get third dose (not protected) VPnot2_S -> VPnot3_S
    transitions[traind[count,g,n],]<-c(varind[28,g,n], -1,varind[38,g,n],+1); count<-count+1 # 112. Pfizer: removed UnProtected Vaccinated get third dose (get protected) VPnot2_R -> VP3_R
    transitions[traind[count,g,n],]<-c(varind[28,g,n], -1,varind[39,g,n],+1); count<-count+1 # 113. Pfizer: removed UnProtected Vaccinated get third dose (not protected) VPnot2_R -> VPnot3_R
    transitions[traind[count,g,n],]<-c(varind[29,g,n], -1,varind[40,g,n],+1); count<-count+1 # 114. JJ: Susceptible Protected Vaccinated get second dose (remain protected) VJ_S -> VJ2_S
    transitions[traind[count,g,n],]<-c(varind[31,g,n], -1,varind[42,g,n],+1); count<-count+1 # 115. JJ: removed Protected Vaccinated get second dose (remain protected) VJ_R -> VJ2_R
    transitions[traind[count,g,n],]<-c(varind[30,g,n], -1,varind[40,g,n],+1); count<-count+1 # 116. JJ: Susceptible UnProtected Vaccinated get second dose (get protected) VJnot_S -> VJ2_S
    transitions[traind[count,g,n],]<-c(varind[30,g,n], -1,varind[41,g,n],+1); count<-count+1 # 117. JJ: Susceptible UnProtected Vaccinated get second dose (not protected) VJnot_S -> VJnot2_S
    transitions[traind[count,g,n],]<-c(varind[32,g,n], -1,varind[42,g,n],+1); count<-count+1 # 118. JJ: removed UnProtected Vaccinated get second dose (get protected) VJnot_R -> VJ2_R
    transitions[traind[count,g,n],]<-c(varind[32,g,n], -1,varind[43,g,n],+1); count<-count+1 # 119. JJ: removed UnProtected Vaccinated get second dose (not protected) VJnot_R -> VJnot2_R
    #waning protection from vaccination
    transitions[traind[count,g,n],]<-c(varind[36,g,n], -1,varind[37,g,n],+1); count<-count+1 # 120. Pfizer: Susceptible Vaccine waning (3rd dose) VP3_S -> VPnot3_S
    transitions[traind[count,g,n],]<-c(varind[38,g,n], -1,varind[39,g,n],+1); count<-count+1 # 121. Pfizer: Removed Vaccine waning (3rd dose) VP3_R -> VPnot3_R
    transitions[traind[count,g,n],]<-c(varind[40,g,n], -1,varind[41,g,n],+1); count<-count+1 # 122. JJ: Susceptible Vaccine waning (2nd dose) VJ2_S -> VJnot2_S
    transitions[traind[count,g,n],]<-c(varind[42,g,n], -1,varind[43,g,n],+1); count<-count+1 # 123. JJ: Removed Vaccine waning (2nd dose) VJ2_R -> VJnot2_R
    #Breakthrough infections from Pfizer 3rd dose
    transitions[traind[count,g,n],]<-c(varind[37,g,n], -1,varind[46,g,n],+1); count<-count+1 # 124 Pfizer Susceptible dose 3 Wild: Breakthrough infections: VPnot3_S -> IPam1
    transitions[traind[count,g,n],]<-c(varind[37,g,n], -1,varind[47,g,n],+1); count<-count+1 # 125 Pfizer Susceptible dose 3 Wild: Breakthrough infections: VPnot3_S -> IPp1
    transitions[traind[count,g,n],]<-c(varind[39,g,n], -1,varind[46,g,n],+1); count<-count+1 # 126 Pfizer Removed dose 3 Wild: Breakthrough infections: VPnot3_R -> IPam1
    transitions[traind[count,g,n],]<-c(varind[39,g,n], -1,varind[47,g,n],+1); count<-count+1 # 127 Pfizer Removed dose 3 Wild: Breakthrough infections: VPnot3_R -> IPp1
    transitions[traind[count,g,n],]<-c(varind[37,g,n], -1,varind[48,g,n],+1); count<-count+1 # 128 Pfizer Susceptible dose 3 NL: Breakthrough infections: VPnot3_S -> IPam2
    transitions[traind[count,g,n],]<-c(varind[37,g,n], -1,varind[49,g,n],+1); count<-count+1 # 129 Pfizer Susceptible dose 3 NL: Breakthrough infections: VPnot3_S -> IPp2
    transitions[traind[count,g,n],]<-c(varind[39,g,n], -1,varind[48,g,n],+1); count<-count+1 # 130 Pfizer Removed dose 3 NL: Breakthrough infections: VPnot3_R -> IPam2
    transitions[traind[count,g,n],]<-c(varind[39,g,n], -1,varind[49,g,n],+1); count<-count+1 # 131 Pfizer Removed dose 3 NL: Breakthrough infections: VPnot3_R -> IPp2
    #Breakthrough infections from JnJ 2nd dose
    transitions[traind[count,g,n],]<-c(varind[41,g,n], -1,varind[50,g,n],+1); count<-count+1 # 132 JJ Susceptible dose 2 Wild: Breakthrough infections: VJnot2_S -> IJam1
    transitions[traind[count,g,n],]<-c(varind[41,g,n], -1,varind[51,g,n],+1); count<-count+1 # 133 JJ Susceptible dose 2 Wild: Breakthrough infections: VJnot2_S -> IJp1
    transitions[traind[count,g,n],]<-c(varind[43,g,n], -1,varind[50,g,n],+1); count<-count+1 # 134 JJ Removed dose 2 Wild: Breakthrough infections: VJnot2_R -> IJam1
    transitions[traind[count,g,n],]<-c(varind[43,g,n], -1,varind[51,g,n],+1); count<-count+1 # 135 JJ Removed dose 2 Wild: Breakthrough infections: VJnot2_R -> IJp1
    transitions[traind[count,g,n],]<-c(varind[41,g,n], -1,varind[52,g,n],+1); count<-count+1 # 136 JJ Susceptible dose 2 NL: Breakthrough infections: VJnot2_S -> IJam2
    transitions[traind[count,g,n],]<-c(varind[41,g,n], -1,varind[53,g,n],+1); count<-count+1 # 137 JJ Susceptible dose 2 NL: Breakthrough infections: VJnot2_S -> IJp2
    transitions[traind[count,g,n],]<-c(varind[43,g,n], -1,varind[52,g,n],+1); count<-count+1 # 138 JJ Removed dose 2 NL: Breakthrough infections: VJnot2_R -> IJam2
    transitions[traind[count,g,n],]<-c(varind[43,g,n], -1,varind[53,g,n],+1); count<-count+1 # 139 JJ Removed dose 2 NL: Breakthrough infections: VJnot2_R -> IJp2
    #counter: actual vaccination counts continued
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[44,g,n],+1); count<-count+1 # 140. Pfizer dose 3: actual vaccination to FV_P3
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[45,g,n],+1); count<-count+1 # 141. JJ dose 2: actual vaccination to FV_J2
    # Recovery back to First vaccine state with hybrid immunity (opportunity to continue vaccination)
    transitions[traind[count,g,n],]<-c(varind[46,g,n], -1,varind[23,g,n],+1); count<-count+1 # 142. Pfizer: recovery of WILD asymp/mild BT infection IPam1 -> VP1_R
    transitions[traind[count,g,n],]<-c(varind[47,g,n], -1,varind[23,g,n],+1); count<-count+1 # 143. Pfizer: recovery of WILD severe BT infection IPp1 -> VP1_R
    transitions[traind[count,g,n],]<-c(varind[48,g,n], -1,varind[23,g,n],+1); count<-count+1 # 144. Pfizer: recovery of NL asymp/mild BT infection IPam2 -> VP1_R
    transitions[traind[count,g,n],]<-c(varind[49,g,n], -1,varind[23,g,n],+1); count<-count+1 # 145. Pfizer: recovery of NL severe BT infection IPp2 -> VP1_R
    transitions[traind[count,g,n],]<-c(varind[50,g,n], -1,varind[31,g,n],+1); count<-count+1 # 146. JnJ: recovery of WILD asymp/mild BT infection IJam1 -> VJ_R
    transitions[traind[count,g,n],]<-c(varind[51,g,n], -1,varind[31,g,n],+1); count<-count+1 # 147. JnJ: recovery of WILD severe BT infection IJp1 -> VJ_R
    transitions[traind[count,g,n],]<-c(varind[52,g,n], -1,varind[31,g,n],+1); count<-count+1 # 148. JnJ: recovery of NL asymp/mild BT infection IJam2 -> VJ_R
    transitions[traind[count,g,n],]<-c(varind[53,g,n], -1,varind[31,g,n],+1); count<-count+1 # 149. JnJ: recovery of NL severe BT infection IJp2 -> VJ_R
    #Death from BT infection for the vaccinated
    transitions[traind[count,g,n],]<-c(varind[47,g,n], -1,varind[11,g,n],+1); count<-count+1 # 150. Pfizer: death of Wild severe BT infection IPp1 -> D
    transitions[traind[count,g,n],]<-c(varind[49,g,n], -1,varind[11,g,n],+1); count<-count+1 # 151. Pfizer: death of Wild severe BT infection IPp2 -> D
    transitions[traind[count,g,n],]<-c(varind[51,g,n], -1,varind[11,g,n],+1); count<-count+1 # 152. Pfizer: death of Wild severe BT infection IJp1 -> D
    transitions[traind[count,g,n],]<-c(varind[53,g,n], -1,varind[11,g,n],+1); count<-count+1 # 153. Pfizer: death of Wild severe BT infection IJp2 -> D
    #Seed BA4/5 sub-lineage
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[10,g,n],+1); count<-count+1 # 154. BA4/5: Seed  -> Er1
    transitions[traind[count,g,n],]<-c(varind[9,g,n], -1,varind[19,g,n],+1); count<-count+1 # 155. BA4/5: R1  -> R2. (speed move)
    transitions[traind[count,g,n],]<-c(varind[21,g,n], -1,varind[46,g,n],+1); count<-count+1 # 156. BA4/5: Pfizer Susceptible dose 1 Wild: Breakthrough infections: VP1_S -> IPam1
    transitions[traind[count,g,n],]<-c(varind[21,g,n], -1,varind[47,g,n],+1); count<-count+1 # 157. BA4/5: Pfizer Susceptible dose 1 Wild: Breakthrough infections: VP1_S -> IPp1
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[46,g,n],+1); count<-count+1 # 158. BA4/5: Pfizer Susceptible dose 2 Wild: Breakthrough infections: VP2_S -> IPam1
    transitions[traind[count,g,n],]<-c(varind[25,g,n], -1,varind[47,g,n],+1); count<-count+1 # 159. BA4/5: Pfizer Susceptible dose 2 Wild: Breakthrough infections: VP2_S -> IPp1
    transitions[traind[count,g,n],]<-c(varind[29,g,n], -1,varind[50,g,n],+1); count<-count+1 # 160. BA4/5: JJ Susceptible dose 1 Wild: Breakthrough infections: VJ_S -> IJam1
    transitions[traind[count,g,n],]<-c(varind[29,g,n], -1,varind[51,g,n],+1); count<-count+1 # 161. BA4/5: JJ Susceptible dose 1 Wild: Breakthrough infections: VJ_S -> IJp1
    transitions[traind[count,g,n],]<-c(varind[23,g,n], -1,varind[46,g,n],+1); count<-count+1 # 162. BA4/5: Pfizer Recovered dose 1 Wild: Breakthrough infections: VP1_R -> IPam1
    transitions[traind[count,g,n],]<-c(varind[23,g,n], -1,varind[47,g,n],+1); count<-count+1 # 163. BA4/5: Pfizer Recovered dose 1 Wild: Breakthrough infections: VP1_R -> IPp1
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[46,g,n],+1); count<-count+1 # 164. BA4/5: Pfizer Recovered dose 2 Wild: Breakthrough infections: VP2_R -> IPam1
    transitions[traind[count,g,n],]<-c(varind[27,g,n], -1,varind[47,g,n],+1); count<-count+1 # 165. BA4/5: Pfizer Recovered dose 2 Wild: Breakthrough infections: VP2_R -> IPp1
    transitions[traind[count,g,n],]<-c(varind[31,g,n], -1,varind[50,g,n],+1); count<-count+1 # 166. BA4/5: JJ Recovered dose 1 Wild: Breakthrough infections: VJ_R -> IJam1
    transitions[traind[count,g,n],]<-c(varind[31,g,n], -1,varind[51,g,n],+1); count<-count+1 # 167. BA4/5: JJ Recovered dose 1 Wild: Breakthrough infections: VJ_R -> IJp1
    #Seed Hypothetical IE variant 
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[10,g,n],+1); count<-count+1 # 168. Hyp IE: Seed  -> Er1
    transitions[traind[count,g,n],]<-c(varind[1,g,n], 0,varind[20,g,n],+1); count<-count+1 # 169. Hyp IE: Seed  -> Er2
    
        count <- count-1 #
      }
}
transitions2<-cbind(transitions[,1],transitions[,3],transitions[,2],transitions[,4] )
transitionsiu1<-transitions2[,1]
transitionsiu2<-transitions2[,2]
transitionsiv1<-transitions2[,3]
transitionsiv2<-transitions2[,4]


# ************************************************************************************* #
#### Set parameters ####
# ************************************************************************************* #
pars = {list(
  gamma1 = uniparam[uniparam$Name=="gamma1",3],  #1/non-infectious incubation duration
  gamma2 = uniparam[uniparam$Name=="gamma2",3],  #1/infectious incubation duration
  r1=uniparam[uniparam$Name=="r1",3], # 1/dur infectiousness (asymptomatic)
  r8=uniparam[uniparam$Name=="r8",3], # 1/dur infectiousness (severe untreated)
  taus=uniparam[uniparam$Name=="taus",3], # 1/trt seeking severe
  zeta1 = uniparam[uniparam$Name=="zeta1",3], #relative infectiousness of asymptomatic population
  transNL=uniparam[uniparam$Name=="transNL",3], #scale factor to imply increased transmissibility of New Lineage
  susR=uniparam[uniparam$Name=="susR",3], #scale factor to imply decreased susceptibility upon reinfection with same lineage 
  susRcross=uniparam[uniparam$Name=="susRcross",3], #scale factor to imply decreased susceptibility in Wild type upon reinfection with NEW lineage
  pdnotTsevnotO2=uniparam[uniparam$Name=="pdnotTsevnotO2",3], #prob of dying out of hospital for sev not in hosp
  pO2=uniparam[uniparam$Name=="pO2",3], #prob of severe case in gen ward needing oxygen (all kinds)
  k_beh=uniparam[uniparam$Name=="k_beh",3], #behavioural response sharpness factor
  delta_dc=uniparam[uniparam$Name=="delta_dc",3], #half-saturation point for daily deaths for behavioural response
  delta_cc=uniparam[uniparam$Name=="delta_cc",3], #half-saturation point for daily symp inc for behavioural response
  pdad=uniparam[uniparam$Name=="pdad",3], #probabilty of death after ICU discharge
  cmd_scale = uniparam[uniparam$Name=="cmd_scale",3], #scale factor to increase in-hosptial mortality for those with comorbidities
  cmh_scale = uniparam[uniparam$Name=="cmh_scale",3], #scale factor to increase hosptial attendance for those with comorbidities
  pa=uniparam[uniparam$Name=="pa",3], # proportion of asymptomatic infection
  pss_scale=uniparam[uniparam$Name=="pss_scale",3], # scale factor to toggle severity of infection
  psr_scale=uniparam[uniparam$Name=="psr_scale",3], # scale factor to toggle severity of reinfection
  amp=uniparam[uniparam$Name=="amp",3], # seasonal amplitude
  
  vscales=vacparam[vacparam$Name=="vscales",3], # reduction factor on severe disease
  peffj=vacparam[vacparam$Name=="peffj",3], # protective eff against severe disease (JnJ)
  peffp=vacparam[vacparam$Name=="peffp",3], # protective eff against severe disease (Pfizer)
  vdelay=vacparam[vacparam$Name=="vdelay",3], # period before protection develops (days)
  
  vstartJ=vacparam[vacparam$Name=="vstartJ",3], # start of Sisonke trial (JnJ)
  vstartP=vacparam[vacparam$Name=="vstartP",3], # start of Gov Roll-out Pfizer & JnJ
  epsP_S=vacparam[vacparam$Name=="epsP_S",3], # Pfizer: protection against infection for 1 dose in naïve population
  epsP_R=vacparam[vacparam$Name=="epsP_R",3], # Pfizer: protection against infection for 1 dose in recovered population
  epsJ_S=vacparam[vacparam$Name=="epsJ_S",3], # JJ: protection against infection for 1 dose in naïve population
  epsJ_R=vacparam[vacparam$Name=="epsJ_R",3], # JJ: protection against infection for 1 dose in recovered population
  epsJ_S2=vacparam[vacparam$Name=="epsJ_S2",3], # JJ: protection against infection for 2 dose in naïve population
  epsJ_R2=vacparam[vacparam$Name=="epsJ_R2",3], # JJ: protection against infection for 2 dose in recovered population
  epsP_S2=vacparam[vacparam$Name=="epsP_S2",3], # Pfizer: protection against infection for 2 doses in naïve population
  epsP_R2=vacparam[vacparam$Name=="epsP_R2",3], # Pfizer: protection against infection for 2 doses in recovered population
  epsP_S3=vacparam[vacparam$Name=="epsP_S3",3], # Pfizer: protection against infection for 3 doses in naïve population
  epsP_R3=vacparam[vacparam$Name=="epsP_R3",3], # Pfizer: protection against infection for 3 doses in recovered population
  sevP_1=(1-vacparam[vacparam$Name=="sevP_1",3]), # Pfizer: VE against severe infection after 1 dose
  sevP_2=(1-vacparam[vacparam$Name=="sevP_2",3]), # Pfizer: VE against severe infection after 2 doses
  sevP_3=(1-vacparam[vacparam$Name=="sevP_3",3]), # Pfizer: VE against severe infection after 3 doses
  sevJ=(1-vacparam[vacparam$Name=="sevJ",3]), # JJ: VE against severe infection after 1 dose
  sevJ2=(1-vacparam[vacparam$Name=="sevJ2",3]), # JJ: VE against severe infection after 2 dose
  omegaP_S1=vacparam[vacparam$Name=="omegaP_S1",3], # Pfizer: waning rate for 1 dose  in naïve population 
  omegaP_S2=vacparam[vacparam$Name=="omegaP_S2",3], # Pfizer: waning rate for 2 doses  in naïve population 
  omegaP_S3=vacparam[vacparam$Name=="omegaP_S3",3], # Pfizer: waning rate for 3 doses  in naïve population 
  omegaP_R1=vacparam[vacparam$Name=="omegaP_R1",3], # Pfizer: waning rate for 1 dose  in recovered population 
  omegaP_R2=vacparam[vacparam$Name=="omegaP_R2",3], # Pfizer: waning rate for 2 doses  in recovered population 
  omegaP_R3=vacparam[vacparam$Name=="omegaP_R3",3], # Pfizer: waning rate for 3 doses  in recovered population 
  omegaJ_S=vacparam[vacparam$Name=="omegaJ_S",3], # JJ: waning rate for 1 dose  in naïve population 
  omegaJ_R=vacparam[vacparam$Name=="omegaJ_R",3], # JJ: waning rate for 1 dose  in recovered population 
  omegaJ_S2=vacparam[vacparam$Name=="omegaJ_S2",3], # JJ: waning rate for 2 dose  in naïve population 
  omegaJ_R2=vacparam[vacparam$Name=="omegaJ_R2",3] # JJ: waning rate for 2 dose  in recovered population 
  
);
} 

#Sub-population specific parameters
pars$alpha <- c(1, 0, 0) #SWITCH for hospital transmission for HCW only
pars$cmdfac <- c(1,pars$cmd_scale,1)
pars$cmhfac <- c(1, pars$cmh_scale, 1)

#Age specific parameters
pars$pss1_ratio<-ageparam$pss1_ratio #WILD: relative distribution of severe infection by age group 
pars$pss2_ratio<-ageparam$pss2_ratio #NL: relative distribution of severe infection by age group
pars$pc<-ageparam$pc #prop critical infection by age group among Severely/Critically ill
pars$pdnotT<-ageparam$pdnotT #prop dying (severe infection) by age group UNTREATED
pars$pd1SA<-ageparam$pd1 #prop dying in hospital (severe infection) by age group in GEN bed
pars$pd2SA<-ageparam$pd2 #prop dying in hospital(critical infection) by age group in ICU bed
pars$pdnotTw3<-ageparam$pdnotT_w3 #prop dying (severe infection) by age group UNTREATED Wave 3
pars$pd1SAw3<-ageparam$pd1_w3 #prop dying in hospital (severe infection) by age group in GEN bed Wave 3
pars$pd2SAw3<-ageparam$pd2_w3 #prop dying in hospital(critical infection) by age group in ICU bed Wave 3
pars$psr_ratio <-ageparam$psr_ratio #relative distribution of severe infection by age group for previously infected population




#### Estimating probability of age-specific susceptibility####
source("RScripts/age_suscept.R")
age_med<-c(7,24.5, 47, 60, 67, 72, 80) # seq(2.5, 85, 5)
pars$psus<-ss[aa%in%age_med]
pars$psus[1]<-1.8*pars$psus[1]; pars$psus[c(2,4)]<-0.5*pars$psus[c(2,4)]; pars$psus[3]<-0.65*pars$psus[3];
pars$psus[c(5:7)]<-0.75*pars$psus[c(5:7)]; 
pars$psus[1]<-0.0065
pars$psus[2]<-0.01
pars$psus[7]<-0.075
#Checks
points(age_med,ss[aa%in%age_med], col=2 )
points(age_med, pars$psus, col=4)
length(pars$psus) == G 


#### Input Function ####
# ************************************************************************************* #
inputs<-function(parmal, scenario){
  # Evaluates inputs into the transition function
}

# ************************************************************************************* #
#Set up matrices for rate function

# ************************************************************************************* #
#### Transition Rates ####
# ************************************************************************************* #
#Object definition 

pop<-popc<-matrix(0, G,N)    # population sizes  
foiS1<-foiS2<-foiR1<-foiR2<- infectious1 <- infectious2<-matrix(0, G,N)     # Wild: force of infection 

tranrate<-array(0,c(N,G,A))   #transition rates array

covrates <- function(x, input, parmal, t,ti, scenario) {
  with(as.list(c( parmal, scenario, getStates(x))),
       {
         t_internal<-(ti-1)*dtout+t+startyear
         import<- array(0,c(G,N)) ##GxN
         if (t_internal<(90/365) ) {
           import[3,] <- c(NLseedfacrun * approx(as.data.frame(hcwNLseedsrun)$t/365, as.data.frame(hcwNLseedsrun)[,2], t_internal, rule=2)$y,
                     NLseedfacrun * approx(as.data.frame(cmNLseedsrun)$t/365, as.data.frame(cmNLseedsrun)[,2], t_internal, rule=2)$y,
                     NLseedfacrun * approx(as.data.frame(EENLseedsrun)$t/365, as.data.frame(EENLseedsrun)[,2], t_internal, rule=2)$y )
           }
         

         importDelta<- array(0,c(G,N)) ##GxN
         if (i9==1 & t_internal>(183/365) & t_internal< (258/365) ) { #1 April 21 - 15 June 21
           importDelta[3,] <- c(deltaseedfacrun * approx(as.data.frame(hcwdeltaseedsrun)$t/365, as.data.frame(hcwdeltaseedsrun)[,2], t_internal, rule=2)$y,
                                deltaseedfacrun * approx(as.data.frame(cmdeltaseedsrun)$t/365, as.data.frame(cmdeltaseedsrun)[,2], t_internal, rule=2)$y,
                                deltaseedfacrun * approx(as.data.frame(EEdeltaseedsrun)$t/365, as.data.frame(EEdeltaseedsrun)[,2], t_internal, rule=2)$y )
         }
         
         importIEvar<- array(0,c(G,N)) ##GxN
         if (i16==1 & t_internal>(336/365) & t_internal< (427/365) ) { #1 September 21 - 1 December 21
           importIEvar[3,] <- c(ievarseedfacrun * approx(as.data.frame(hcwievarseedsrun)$t/365, as.data.frame(hcwievarseedsrun)[,2], t_internal, rule=2)$y,
                                ievarseedfacrun * approx(as.data.frame(cmievarseedsrun)$t/365, as.data.frame(cmievarseedsrun)[,2], t_internal, rule=2)$y,
                                ievarseedfacrun * approx(as.data.frame(EEievarseedsrun)$t/365, as.data.frame(EEievarseedsrun)[,2], t_internal, rule=2)$y )
         }
         
         importBA45var<- array(0,c(G,N)) ##GxN
         if (i16==1 & t_internal>(489/365) & t_internal< (562/365) ) { #1 February 22 - 15 May 22
           importBA45var[3,] <- c(ba45varseedfacrun * approx(as.data.frame(hcwba45varseedsrun)$t/365, as.data.frame(hcwba45varseedsrun)[,2], t_internal, rule=2)$y,
                                  ba45varseedfacrun * approx(as.data.frame(cmba45varseedsrun)$t/365, as.data.frame(cmba45varseedsrun)[,2], t_internal, rule=2)$y,
                                  ba45varseedfacrun * approx(as.data.frame(EEba45varseedsrun)$t/365, as.data.frame(EEba45varseedsrun)[,2], t_internal, rule=2)$y )
         }
         
         importhypIEvar<- array(0,c(G,N)) ##GxN
         if (i16==1 & t_internal>(1066/365) & t_internal< (1156/365) ) { #1 September 23 - 30 Nov 23
           importhypIEvar[3,] <- c(hypIEvarseedfacrun * approx(as.data.frame(hcwhypIEvarseedsrun)$t/365, as.data.frame(hcwhypIEvarseedsrun)[,2], t_internal, rule=2)$y,
                                  hypIEvarseedfacrun * approx(as.data.frame(cmhypIEvarseedsrun)$t/365, as.data.frame(cmhypIEvarseedsrun)[,2], t_internal, rule=2)$y,
                                  hypIEvarseedfacrun * approx(as.data.frame(EEhypIEvarseedsrun)$t/365, as.data.frame(EEhypIEvarseedsrun)[,2], t_internal, rule=2)$y )
         }
         
         
        # NPIs
         #dates reference 1/365 = startdate
         Rdec<-1
        # i2 NPI reduction in R0 -- google residential data
         if (i2==1){
           Rdec<- 1-(approx(as.data.frame(NPIrun)$t/365, as.data.frame(NPIrun)[,2], t_internal, rule=2)$y )
         }
         
         
         #Apply co-morbidity factors
         #increased increased severity for co-morbid pop
         pss1 <- matrix(rep(pss1,N), G,N)%*%diag(cmhfac)
         
         #reduction in severity of omicron ####
         if (t_internal > 411/365) {
           pss2<-Osevdec*pss2
           pd1run[1]<-0.58*pd1run
           pd2run[1]<-0.742*pd2run
         }
         
         #reduction in severity of BA4/5 (same as omicron) ####
         if (t_internal > 489/365) {
           pss1<-Osevdec*pss1
           pd1run[1]<-0.58*pd1run
           pd2run[1]<-0.742*pd2run
         }
         
         
         pss2 <- matrix(rep(pss2,N), G,N)%*%diag(cmhfac)
         pss1[pss1>1]<-0.95; pss2[pss2>1]<-0.95
         if (sum((pss1 > 0.95), (pss2 >0.95)) > 0) {stop("prob of severity >1 ")}
         
         
         #increased death
         pd1 <- matrix(rep(pd1run,N), G,N)%*%diag(cmdfac)
         pd2 <- matrix(rep(pd2run,N), G,N)%*%diag(cmdfac)
         if (sum((pd1 >= 1), (pd2 >=1)) > 0) {stop("prob of death >1 ")}
         
        
         #Weight relative infectiousness for I_am - using weights of prop of asymptomatic and severe illness
         zeta2_1 <- (zeta1*pa + 1*(1-pa)*pss1)/(pa+(1-pa)*pss1) #Wild type
         zeta2_2 <- (zeta1*pa + 1*(1-pa)*pss2)/(pa+(1-pa)*pss2)  #New Lineage
         
         # Vaccine protection against disease
        psvs = pss2
          #Indirect effects
         if (i6 ==1){
           psvs <- pss2*vscales
        }

        #direct effects (not used)
        vprop<-matrix(0,G,N)
        vproc <- as.matrix(vprop)%*%diag(c(peffj, peffp, peffp)) # proportion of people protected 
       
      ####Indirect & direct impact####
        
        
        vdose1<-array(0, c(G,N)); vcov1 <- vdose1; row.names(vdose1)<-1:G
        vdose2<-array(0, c(G,N));vcov2 <- vdose2; row.names(vdose2)<-1:G
        vdose3<-array(0, c(G,N));vcov3 <- vdose3; row.names(vdose3)<-1:G
        vdoseJ<-array(0, c(G,N));vcovJ <- vdoseJ; row.names(vdoseJ)<-1:G
        vdoseJ2<-array(0, c(G,N));vcovJ2 <- vdoseJ2; row.names(vdoseJ2)<-1:G
        
        dur<-1/365
        vtarget1 <-.S + .R1+ .R2
        vtarget2<-.VP1_S + .VP1_R + .VPnot1_S +.VPnot1_R
        vtarget3<-.VP2_S + .VP2_R + .VPnot2_S +.VPnot2_R
        vtargetJ<-.VJ_S + .VJ_R + .VJnot_S +.VJnot_R
        
        #if(t_internal>382/365) { browser()}
        
        #Sisonke roll-out 17 Feb to 17 May 21
        if ((t_internal >= vstartJ/365) & (t_internal < 229/365)){ 
          vdose1<-vcov1 <- 0
          vdose2<-vcov2 <- 0
          vdoseJ[row.names(vdoseJ)%in%evds229_Jrun$age,1]=evds229_Jrun$tot_fd
          vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
          dur <- (229 - vstartJ)/365
        }
        #Government roll-out 17 May ->
        {
          #Gov roll-out 17 May 21 - 27 June 21
          if ((t_internal >= 229/365) & (t_internal < 271/365)){ 
            vdose1[row.names(vdose1)%in%evds271_1run$age,]=evds271_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds271_2run$age,]=evds271_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdoseJ[row.names(vdoseJ)%in%evds271_Jrun$age,]=evds271_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            dur <- (271 - 229)/365
          }

          #Gov roll-out 28 June 21 - 29 August 21
          if ((t_internal >= 271/365) & (t_internal < 334/365)){
            vdose1[row.names(vdose1)%in%evds334_1run$age,]=evds334_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))
            vdose2[row.names(vdose2)%in%evds334_2run$age,]=evds334_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdoseJ[row.names(vdoseJ)%in%evds334_Jrun$age,]=evds334_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            dur <- (334 - 271)/365
          }
          
          #Gov roll-out 30 August 21 - 17 October 21
          if ((t_internal >= 334/365) & (t_internal < 383/365)){ 
            vdose1[row.names(vdose1)%in%evds383_1run$age,]=evds383_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds383_2run$age,]=evds383_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdoseJ[row.names(vdoseJ)%in%evds383_Jrun$age,]=evds383_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            dur <- (383 - 334)/365
            
          }
          
          #Gov roll-out 18 October 21 - 21 November 2021
          
          if ((t_internal >= 383/365) & (t_internal < 418/365)){ 
            vdose1[row.names(vdose1)%in%evds418_1run$age,]=evds418_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds418_2run$age,]=evds418_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds418_3run$age,]=evds418_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds418_Jrun$age,]=evds418_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds418_J2run$age,]=evds418_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (418 - 383)/365
            
          }
          
          
          #Gov roll-out 22 Nov 21 - 15 December 21 
     #     if(t_internal >=420/365) {browser()}
          
          if ((t_internal >= 418/365) & (t_internal < 446/365)){ 
            vdose1[row.names(vdose1)%in%evds446_1run$age,]=evds446_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds446_2run$age,]=evds446_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds446_3run$age,]=evds446_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds446_Jrun$age,]=evds446_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds446_J2run$age,]=evds446_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (446 - 418)/365
            
          }
          
          #Gov roll-out 20 Dec 21 - 7 March 2022
          if ((t_internal >= 446/365) & (t_internal < 523/365)){ 
            vdose1[row.names(vdose1)%in%evds523_1run$age,]=evds523_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds523_2run$age,]=evds523_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds523_3run$age,]=evds523_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds523_Jrun$age,]=evds523_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds523_J2run$age,]=evds523_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (523 - 446)/365
            
          }
          
          #Gov roll-out 7 March 2022 - 11 April 2022
         #         if(t_internal >=523/365) {browser()}
          
          if ((t_internal >= 523/365) & (t_internal < 558/365)){ 
            vdose1[row.names(vdose1)%in%evds558_1run$age,]=evds558_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds558_2run$age,]=evds558_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds558_3run$age,]=evds558_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds558_Jrun$age,]=evds558_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds558_J2run$age,]=evds558_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (558 - 523)/365
            
          }
          
          #Gov roll-out 11 April 2022 - 30 May 2022
          if ((t_internal >= 558/365) & (t_internal < 607/365)){ 
            vdose1[row.names(vdose1)%in%evds607_1run$age,]=evds607_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds607_2run$age,]=evds607_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds607_3run$age,]=evds607_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds607_Jrun$age,]=evds607_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds607_J2run$age,]=evds607_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (607 - 558)/365
            
          }
          
          #Gov roll-out 1 June 2022 - 31 Dec 2022
          if ((t_internal >= 607/365) & (t_internal < 823/365)){ 
            vdose1[row.names(vdose1)%in%evds823_1run$age,]=evds823_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds823_2run$age,]=evds823_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds823_3run$age,]=evds823_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds823_Jrun$age,]=evds823_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds823_J2run$age,]=evds823_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (823 - 607)/365
            
          }
          
          #Gov roll-out 1 Jan 2023 - 28 Feb 2023
          if ((t_internal >= 823/365) & (t_internal < 881/365)){ 
            vdose1[row.names(vdose1)%in%evds881_1run$age,]=evds881_1run$tot_fd ; vdose1<-vdose1*(apprun/rowSums(apprun))  
            vdose2[row.names(vdose2)%in%evds881_2run$age,]=evds881_2run$tot_sd ; vdose2<-vdose2*(vtarget2/rowSums(vtarget2))  
            vdose3[row.names(vdose3)%in%evds881_3run$age,]=evds881_3run$tot_bd ; vdose3<-vdose3*(vtarget3/rowSums(vtarget3))  
            vdoseJ[row.names(vdoseJ)%in%evds881_Jrun$age,]=evds881_Jrun$tot_fd ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))  
            vdoseJ2[row.names(vdoseJ2)%in%evds881_J2run$age,]=evds881_J2run$tot_bd ; vdoseJ2<-vdoseJ2*(vtargetJ/rowSums(vtargetJ)) 
            
            vcov1 <- vdose1/apprun; vcov1[is.nan(vcov1)]<-0
            vcov2 <- vdose2/vtarget2; vcov2[is.nan(vcov2)]<-0
            vcov3 <- vdose3/vtarget3; vcov3[is.nan(vcov3)]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.nan(vcovJ)]<-0
            vcovJ2 <- vdoseJ2/vtargetJ; vcovJ2[is.nan(vcovJ2)]<-0
            dur <- (881 - 823)/365
            
          }
          
          
        }
      

        # # Scenario rollouts: 70 full vaccination
        if ((t_internal >= 881/365) & (t_internal < 1187/365) & i14==1){ #CHANGE with new EVDS
        vdose1 <- 0.72*fvreq70run
        vdoseJ <- 0.28*fvreq70run
        vcov1 <- vdose1/apprun; vcov1[is.na(vcov1)]<-0
        vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)]<-0
        dur <- (1187 - 881)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
        }
        
        # Scenario rollouts: individual target vaccination
        # 40-20-40 rollout 70% coverage --75% coverageof 60+
        { #11 April - 30 Sep 22 
          # if ((t_internal >= 418/365) & (t_internal < 458/365) & i15==1){ #CHANGE with new EVDS
          #   vdose1 <- 0.72*ivreq70.4run;
          #   vdoseJ <- 0.28*ivreq70.4run
          #   vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
          #   vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
          #   dur <- (458 - 418)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
          # }
          # 
          # if ((t_internal >= 458/365) & (t_internal < 489/365) & i15==1){ #CHANGE with new EVDS
          #   vdose1 <- 0.72*ivreq70.2run;
          #   vdoseJ <- 0.28*ivreq70.2run
          #   vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
          #   vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
          #   dur <- (489 - 458)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
          # }
          
          if ((t_internal >= 881/365) & (t_internal < 1187/365) & i15==1){ #CHANGE with new EVDS
            vdose1 <- 0.72*ivreq70run;
            vdoseJ <- 0.28*ivreq70run
            vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
            dur <- (1187 - 881)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
          }
        }
        # catchup to reach 60% total coverage
        if ((t_internal >= 881/365) & (t_internal < 1187/365) & i22==1){ #CHANGE with new EVDS
          vdose1 <- 0.72*ivreq60run;
          vdoseJ <- 0.28*ivreq60run
          vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
          vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
          dur <- (1187 - 881)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
        }
       
     
        # 40-20-40 rollout 90% coverage of 60+ --> 70% overall
        {
          if ((t_internal >= 881/365) & (t_internal < 1096/365) & i17==1){ #CHANGE with new EVDS
            vdose1 <- 0.72*ivreq90run;
            vdoseJ <- 0.28*ivreq90run
            #         vdose1[row.names(vdose1)%in%altrun$age,]=altrun$tot_fd1 ; vdose1<-vdose1*(apprun/rowSums(apprun))
            #          vdoseJ[row.names(vdoseJ)%in%altrun$age,]=altrun$tot_fdJ ; vdoseJ<-vdoseJ*(apprun/rowSums(apprun))
            vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
            vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
            dur <- (1096 - 881)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
          }
          
          # if ((t_internal >= 881/365) & (t_internal < 1187/365) & i17==1){ #CHANGE with new EVDS
          #   vdose1 <- 0.72*ivreq90.2run;
          #   vdoseJ <- 0.28*ivreq90.2run
          #   vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
          #   vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
          #   dur <- (1100 - 881)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
          # }
          # 
          # if ((t_internal >= 881/365) & (t_internal < 1187/365) & i17==1){ #CHANGE with new EVDS
          #   vdose1 <- 0.72*ivreq90.4run;
          #   vdoseJ <- 0.28*ivreq90.4run
          #   vcov1 <- vdose1/apprun; vcov1[is.na(vcov1) | vcov1<0 ]<-0
          #   vcovJ <- vdoseJ/apprun; vcovJ[is.na(vcovJ)| vcov1<0 ]<-0
          #   dur <- (1100 - 881)/365 #need to adjust duration to take into account 1 doses who are yet to receive 2nd dose
          # }
        
        }
        
        
        vcov1<-pmin(vcov1, matrix(0.98, G, N))
        vcov2<-pmin(vcov2, matrix(0.98, G, N))
        vcov3<-pmin(vcov3, matrix(0.98, G, N))
        vcovJ<-pmin(vcovJ, matrix(0.98, G, N))
        vcovJ2<-pmin(vcovJ2, matrix(0.98, G, N))
        
        nu1<-nu2<-nu3<-nuJ<-nuJ2<-nu1act<-nu2act<-nu3act<-nuJact<-nuJ2act <-0
        # vaccination switch
        if (i10==1|i14==1|i15==1|i17==1 | i22==1) { 
          adj1 = apprun/vtarget1; adj1[is.nan(adj1) | is.infinite((adj1))]<-0
          adj2 = apprun/vtarget2; adj2[is.nan(adj2) | is.infinite((adj2))]<-0
          adhoc = c(0.92,0.92,0.92,0.85, 0.88,0.88, 0.88)
          nu1act= (-log(1 - vcov1)/dur)*adhoc*adj1
          nu2act= (-log(1 - vcov2)/dur)*adhoc#adj2
          nu3act= (-log(1 - vcov3)/dur)*adhoc#adj2
          nuJact= (-log(1 - vcovJ)/dur)*adhoc*adj1
          nuJ2act= (-log(1 - vcovJ2)/dur)*adhoc#*adj1
          
          nu1= 1/(1/nu1act + 1/vdelay)
          nu2= 1/(1/nu2act) # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          nu3= 1/(1/nu3act) # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V2
          nuJ= 1/(1/nuJact + 1/vdelay)
          nuJ2= 1/(1/nuJ2act) # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from VJ
          
        }
        
        # vaccination future scenario switch 2nd dose adjustment
        if ((t_internal >= 881/365) & (i14==1|i15==1|i17==1 | i22==1)) { 
          nu1act= (-log(1 - vcov1)/dur)*adj1
          nu2act = 365/42 # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          nu3act = 365/365 # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          nuJact= (-log(1 - vcovJ)/dur)*adj1
          nuJ2act = 365/365 # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          
          nu1= 1/(1/nu1act + 1/vdelay)
          nu2 = 365/42 # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          nu3 = 365/365 # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          nuJ=  1/(1/nuJact + 1/vdelay)
          nuJ2 = 365/365 # do not incorporate a second 2 week delay as it messes up counts of vaccines as delay already in effect from V1
          
          
        }
        
        
      #Behavioral response parameters #excess deaths or model deaths
        dprime=0; beh=1
        delta_dcrun<- delta_dc1run
        Cdelta_dcrun<- Cdelta_dc1run
        k_behrun <- k_beh1run
        if (t_internal >= (183/365) & i13==0) { 
          delta_dcrun<- delta_dc2run
          Cdelta_dcrun<- Cdelta_dc2run
          k_behrun <- k_beh2run
          }
       # delta_dcrun<- (t_internal < (183/365) & i13==0)*delta_dc1run + (1-(t_internal < (183/365) & i13==0))*delta_dc2run 
        
        #behavioural response to total deaths (in/out hospital)
        if (i3==1){
          dprime = sum( pdnotT*r8*.IsnotT1 + pd1*r3run*.H1 + pd2*r4run*.ICU1 + (1-pd2)*pdad*r4run*.ICU1 +
                          pdnotT*r8*.IsnotT2 + pd1*r3run*.H2 + pd2*r4run*.ICU2 + (1-pd2)*pdad*r4run*.ICU2) / 365
          Cdprime = sum(.D)
          beh<-(1+(dprime/delta_dcrun)^k_behrun + (Cdprime/Cdelta_dcrun)^k_behrun)
        }
        #behavioural response to symptomatic incidence #breakthrough vaccine symp incidence considered without delay (circular)
        if (i4==1){
          dprime = sum((1-pa)*gamma1*(.E1 + .Er1 + .Vd1notP + .Vd2notP) +
                         (1-pa)*gamma1*(.E2 + .Er2 + .Vd1notP + .Vd2notP) ) / 365
          beh<-(1+(dprime/delta_ccrun)^k_behrun)
        }
      
    #i5 seasonality 
        seas = 1
        if (i5==1){
          seas = (1+amp*cos(2*pi*(t_internal + 92/365)))
        }
          
    # i7 reduction in NPI
        if (i7==1 & t_internal > NPIstop/365){
          Rdec <- 1
          #Rdec<-(t_internal<27/365)*Rdec + (t_internal>=27/365)*(t_internal<48/365)*0.7*Rdec+(t_internal>=48/365)*0.9*Rdec
        }
        
    # i8  decreased response.
        if (i8==1 & i3==1 & i13==0 & ((t_internal >= beh_dec_startrun/365 & t_internal < beh_dec_stoprun/365) ) ){
         # Rdec <- 1
          dprime = sum( pdnotT*r8*.IsnotT1 + pd1*r3run*.H1 + pd2*r4run*.ICU1 + (1-pd2)*pdad*r4run*.ICU1 +
                          pdnotT*r8*.IsnotT2 + pd1*r3run*.H2 + pd2*r4run*.ICU2 + (1-pd2)*pdad*r4run*.ICU2) / 365
          Cdprime = sum(.D)
          beh<-(1+(dprime/(beh_decrun*delta_dcrun))^k_behrun + (Cdprime/(beh_decrun*Cdelta_dcrun))^k_behrun) 
          #Rdec<-(t_internal<27/365)*Rdec + (t_internal>=27/365)*(t_internal<48/365)*0.7*Rdec+(t_internal>=48/365)*0.9*Rdec
        }        
         
        if (i8==1 & i3==1 & i13==0 & (( t_internal >= beh_dec_start2/365) ) ){
          # Rdec <- 1
          beh_decrun <- beh_scen*beh_decrun
          dprime = sum( pdnotT*r8*.IsnotT1 + pd1*r3run*.H1 + pd2*r4run*.ICU1 + (1-pd2)*pdad*r4run*.ICU1 +
                          pdnotT*r8*.IsnotT2 + pd1*r3run*.H2 + pd2*r4run*.ICU2 + (1-pd2)*pdad*r4run*.ICU2) / 365
          Cdprime = sum(.D)
          beh<-(1+(dprime/(beh_decrun*delta_dcrun))^k_behrun + (Cdprime/(beh_decrun*Cdelta_dcrun))^k_behrun) 
          #Rdec<-(t_internal<27/365)*Rdec + (t_internal>=27/365)*(t_internal<48/365)*0.7*Rdec+(t_internal>=48/365)*0.9*Rdec
        }    
        
        #i13 Linking ST awareness threshold to changes in CPI
        if (i13==1 & i8==0 & (( t_internal > 90/365) )){
          dynfacrun<- approx(as.data.frame(beh_npirun)$t/365, as.data.frame(beh_npirun)[,2], t_internal, rule=2)$y 
          dprime = sum( pdnotT*r8*.IsnotT1 + pd1*r3run*.H1 + pd2*r4run*.ICU1 + (1-pd2)*pdad*r4run*.ICU1 +
                          pdnotT*r8*.IsnotT2 + pd1*r3run*.H2 + pd2*r4run*.ICU2 + (1-pd2)*pdad*r4run*.ICU2) / 365
          Cdprime = sum(.D)
          beh<-(1+(dprime/(dynfacrun*delta_dcrun))^k_behrun + (Cdprime/(Cdelta_dcrun))^k_behrun) 
        }
        
  #  if (t_internal>=250/365){browser()}
    # i9 Delta variant start
        dFOIscale<-1
        if (i9==1 & t_internal > deltastart/365){
          dFOIscale<-deltatranscale 
        }
        
    # i16 Immune Escape variant start
    transcale<-(1+transNL)
    susR2 <- susR
    if (i16==1 & t_internal > ievarstartrun/365){
      transcale<-Otrans*deltatranscale
      susR2<-escape
      susRcross <-susR2
    }  
    
    # i20 BA4/5 variant start
    if (i9==1 & i20==1 & t_internal > ba45varstart/365){
      dFOIscale<-Otrans*deltatranscale #same transmissability as Omicron
      susBA45cross<-escapeBA45scale*escape
    }
    
    # i23 Hyp IE variant start
    if (i23==1 & t_internal >= hypIEvarstart/365){
      dFOIscale<-Otrans*deltatranscale #same transmissability as Omicron
      sushypIEcross<-escapehypIEscale*escape
    }
    
         infectious1 <- (array((zeta2_1*(x[varind[3,,]]+x[varind[46,,]]+x[varind[50,,]])+zeta1*x[varind[4,,]]+x[varind[5,,]]+x[varind[6,,]]+x[varind[47,,]]+x[varind[51,,]]), c(G,N))+array((x[varind[7,,]]+x[varind[8,,]]), c(G,N))%*%diag(alpha))/.pop
         infectious2 <- (array((zeta2_2*(x[varind[13,,]]+x[varind[48,,]]+x[varind[52,,]])+zeta1*x[varind[14,,]]+x[varind[15,,]]+x[varind[16,,]]+x[varind[49,,]]+x[varind[53,,]]), c(G,N))+array((x[varind[17,,]]+x[varind[18,,]]), c(G,N))%*%diag(alpha))/.pop
         infectious1[is.na(infectious1)]<-0; infectious2[is.na(infectious2)]<-0 #accounting for 0 HCW and CM in kid group

         for (n in 1:N) {
           foiS1[,n] <- dFOIscale*seas*(ptrans0run*Rdec*contactrun%*%infectious1[,n]*psus)  #Wild: Susceptible
           foiS2[,n] <- transcale*seas*(ptrans0run*Rdec*contactrun%*%infectious2[,n]*psus) #NL: Susceptible
         }

         foiR1 <- foiS1*susR #Wild: Removed (and Delta and BA4/5 - to self-reinfect)
         foiR2 <- foiS2*susR #NL: Removed (Beta and later IE to self-reinfect)
         foiR1cross<-foiS2*susRcross #Cross infection with Beta
         foiR2cross <- 0
         if (i9==1 & t_internal > deltastart/365) {
           foiR2cross<-foiS1*susDeltacross # Cross infection with delta
         }
         
         #Delayed Vaccine Breakthrough infections
         Dfoi1VS <-1/(beh/foiS1 + 1/gamma1)
         Dfoi1VR <-1/(beh/foiR1 + 1/gamma1) 
         Dfoi2VS <-1/(beh/foiS2 + 1/gamma1)
         Dfoi2VR <-1/(beh/foiR2 + 1/gamma1)
         
         sevP_1R<-sevP_1
         sevP_2R<-sevP_2
         sevP_3R<-sevP_3
         sevJR<-sevJ
         sevJ2R<-sevJ2
         
         
          #Immune escape variant ####
         Dfoi2VSi16 = 0
         sevP_1i16 <- sevP_1
         sevP_1Ri16 <- sevP_1
         sevP_2i16 <-sevP_2
         sevP_2Ri16 <-sevP_2
         sevJi16 <- sevJ
         sevJRi16 <- sevJ
         sevRi18 <- sevReinRed
         #loss <- 0 trigger to allow for loss of protection from previously protected and infected PRs
         sevP_1Ri18 <- sevP_1
         sevP_2Ri18 <- sevP_2
         sevJRi18 <- sevJ
         
         if (i16==1 & t_internal > ievarstartrun/365 ) {
           foiR2cross<-0 # Cross infection with delta 
         #  Dfoi1VR <-1/(beh/(foiS1*susR2) + 1/gamma1)  #IE from Vaccine not protected R Delta
           Dfoi2VR <-1/(beh/(foiS2*susR2) + 1/gamma1)  #IE from Vaccine not protected R IEvar
           Dfoi2VSi16 <-1/(beh/(foiS2*susR2) + 1/gamma1)  #IE from Vaccine  protected S IEvar
         # taus <-365/2
           }
         
         betaRmove<-0
         if (i16==1 & t_internal > ievarstartrun/365 & t_internal < (ievarstartrun+10)/365) {
           betaRmove<-365/1.25 # move previous beta infected to join Wild, Delta in Removed
         }
         
         # if (i16==1 & i18==0 & t_internal > ievarstartrun/365) {
         #   sevP_1i16 <- sevP_2i16 <- sevJi16 <- 1  #IE lose vaccine severity protection
         # }

         if (i16==1 & i18==1 & t_internal > ievarstartrun/365) {
         sevP_1i16 <- 1-(1-sev_escfac)*(1-sevP_1)
         sevP_2i16 <- 1-(1-sev_escfac)*(1-sevP_2)
         sevJi16 <- 1-(1-sev_escfac)*(1-sevJ)
         sevRi18<- 1-(1-sev_escfac)*(1-sevReinRed)
         sevP_1Ri18 <-sev_escP1_b
         sevP_2Ri18 <-sev_escP2_b
         sevJRi18 <-sev_escJ_b
         }

         #BA4/5 variant (immune escape)
         Dfoi1VSi20<-0
         if (i20==1 & t_internal > ba45varstart/365 ) {
           foiR2cross<-foiS1*susBA45cross # Cross infection with BA4/5
           foiR1cross<-0 # Stops BA4/5 recovered cross infection with Omicron 
           #if too much BA4/5 infection, then only reinfect from Omicron unvacc infected. 
           Dfoi1VR <-1/(beh/(foiR1*susBA45cross) + 1/gamma1)  #Immune Escape from Vaccine not protected R 
 #          Dfoi1VS <-1/(beh/(foiS1*susBA45cross) + 1/gamma1)  #Immune Escape from Vaccine not protected S 
           Dfoi1VSi20 <-1/(beh/(foiS1*susBA45cross) + 1/gamma1)  #Immune Escape from Vaccine  protected S BA4/5
         }
         
         # if (i20==1 & t_internal > ba45varstart/365 & t_internal < (ba45varstart+180)/365 ) {
         #   omegaP_R1<-omegaJ_R<-365/91.25  #faster waning from doubly protected states following Omicron
         # }
         
         deltaRmove<-0
         if (i20==1 & t_internal > ba45varstart/365 & t_internal < (ba45varstart+10)/365) {
           deltaRmove<-365/1.25 # move previous wild, beta, delta infected to join Omicron infected in Removed 2 to allow continued reinfection with Omicron
         }
         
         #HypIE variant (immune escape)
         if (i23==1 & t_internal > hypIEvarstart/365 ) {
            foiR1<-foiS1*sushypIEcross
            foiR2<-foiS2*sushypIEcross
           foiR2cross<-0*foiS2*sushypIEcross # cross infection unnecessary as only self infection occuring in both
           foiR1cross<-0*foiS1*sushypIEcross # Stops BA4/5 recovered cross infection with Omicron 
           #if too much BA4/5 infection, then only reinfect from Omicron unvacc infected. 
           Dfoi1VR <-1/(beh/(foiS1*sushypIEcross) + 1/gamma1)  #Immune Escape from Vaccine not protected R 
       #    Dfoi1VS <-1/(beh/(foiS1*sushypIEcross) + 1/gamma1)  #Immune Escape from Vaccine not protected S 
           Dfoi2VR <-1/(beh/(foiS2*sushypIEcross) + 1/gamma1)  #Immune Escape from Vaccine not protected R 
      #     Dfoi2VS <-1/(beh/(foiS2*sushypIEcross) + 1/gamma1)  #Immune Escape from Vaccine not protected S 
            Dfoi1VSi20 <-0*1/(beh/(foiS1*sushypIEcross) + 1/gamma1)  #Immune Escape from Vaccine  protected S BA4/5
            Dfoi2VSi16 <-0*1/(beh/(foiS2*sushypIEcross) + 1/gamma1)  #IE from Vaccine  protected S IEvar
    #     loss=1
            }
         
         # #faster waning from all protected states during hypIE
         # if (i23==1 & t_internal > hypIEvarstart/365 & t_internal < (hypIEvarstart+180)/365 ) {
         #   omegaP_R1<-omegaP_R2<-omegaP_R3<-omegaP_S1<-omegaP_S2<-omegaP_S3<-omegaJ_R<-omegaJ_R2<-omegaJ_S<-omegaJ_S2<-365/91.25  #faster waning from doubly protected states following intro of hyp IE
         # }
         
        # if (t_internal>1096/365){browser()}
         #reduced severity protection from all vaccinated states during hypIE
         if (i23==1 & i24==1 & t_internal > hypIEvarstart/365 ) {
           sevP_1<-sevP_2<-sevP_3<-sevP_1R<-sevP_2R<-sevP_3R<-sevJ<-sevJ_2<-sevJR<-sevJ_2R<-sevP_1i16<-sevP_2i16<-sevJi16<-sevP_1Ri16<-sevP_2Ri16<-sevJRi16<-sevRi18<-sushypIEcross
         }
        
         if (i23==1 & i25==1 & t_internal > hypIEvarstart/365 & t_internal < (hypIEvarstart+180)/365 ) { 
           # omegaP_S1<-omegaP_S2<-omegaP_S3<-omegaJ_S<-omegaJ_S2<-365/91.25  #faster waning from doubly protected states following intro of hyp IE
           # omegaP_R1<-omegaP_R2<-omegaP_R3<-omegaJ_R<-omegaJ_R2<-365/182.5 #pre-hypIEvariant waning rate
           sevP_1<-sevP_2<-sevP_3<-sevJ<-sevJ_2<-sevP_1i16<-sevP_2i16<-sevJi16<-sevRi18<-sushypIEcross
         }
         
        # tranrates ####
    #   if (t_internal>400/365) {browser()}
         tranrates <- array(c(
           #Incidence
           foiS1/beh*.S,       # 1. incidence S to E1     
           (1-((1-pa)*pss1*(1-vproc)))*gamma1*.E1,       # 2. incubation E1 to Iam1     
           (1-pa)*pss1*(1-vproc)*gamma1*.E1,       # 3. incubation E1 to Ip1     
           (1-ptsrun)*gamma2*.Ip1,       # 4. untreated severe infection Ip1 to IsnotT1       
           ptsrun*gamma2*.Ip1,       #  5. treated severe infection Ip1 to Ist1       
           (1-pc)*taus*.Ist1,       # 6. hosp severe Ist1 to H1        
           pc*taus*.Ist1,   # 7. hosp critical infection Ist1 to ICU1 (non-ICU)    
 
           #Recovery
           r1*.Iam1,       # 8. natural recovery Iam1 to R1   
           (1-pdnotT)*r8*.IsnotT1,        # 9. natural recovery IsnotT1 to R1        
           pdnotT*r8*.IsnotT1,         # 10. death IsnotT1 to D       
           (1-pd1)*r3run*.H1,         # 11. severe discharged H1 to R1      
           pd1*r3run*.H1,       # 12. severe died H1 to D      
           (1-pd2)*(1-pdad)*r4run*.ICU1,         #  13. critical discharged ICU1 to R1
           pd2*r4run*.ICU1,         #  14. critical died ICU1 to D

           #Reinfection
           foiR1/beh*.R1,         #  15. reinfection R1 -> Er1
           (1-((1-pa)*psr*sevRi18*(1-vproc)))*gamma1*.Er1,     #  16. incubation Er1 to Iam1
           (1-pa)*psr*sevRi18*(1-vproc)*gamma1*.Er1,         #  17. incubation Er1 to Ip1

           #New Lineage transitions
           
           foiS2/beh*.S,       # 18. incidence S to E2     
           (1-((1-pa)*pss2*(1-vproc)))*gamma1*.E2,       # 19. incubation E2 to Iam2     
           (1-pa)*pss2*(1-vproc)*gamma1*.E2,       # 20. incubation E2 to Ip2     
           (1-ptsrun)*gamma2*.Ip2,       # 21. untreated severe infection Ip2 to IsnotT2       
           ptsrun*gamma2*.Ip2,       #  22. treated severe infection Ip2 to Ist2       
           (1-pc)*taus*.Ist2,       # 23. hosp severe Ist2 to H2        
           pc*taus*.Ist2,   # 24. hosp critical infection Ist2 to ICU2     
           
           #Recovery
           r1*.Iam2,       # 25. natural recovery Iam2 to R2   
           (1-pdnotT)*r8*.IsnotT2,        # 26. natural recovery IsnotT2 to R2        
           pdnotT*r8*.IsnotT2,         # 27. death IsnotT2 to D       
           (1-pd1)*r3run*.H2,         # 28. severe discharged H2 to R2      
           pd1*r3run*.H2,       # 29. severe died H2 to D      
           (1-pd2)*(1-pdad)*r4run*.ICU2,         #  30. critical discharged ICU2 to R2
           pd2*r4run*.ICU2,         #  31. critical died ICU2 to D
           
           #Reinfection
           foiR2/beh*.R2,         #  32. reinfection R2 -> Er2
           (1-((1-pa)*psr*sevRi18*(1-vproc)))*gamma1*.Er2,     #  33. incubation Er2 to Iam2
           (1-pa)*psr*sevRi18*(1-vproc)*gamma1*.Er2,         #  34. incubation Er2 to Ip2           
         
           #Cross infection
           foiR1cross/beh*.R1,         #  35. reinfection R1 -> Er2
           
           #Vaccination 
           #Pfizer vaccination
           epsP_S*nu1*.S,    #36. Pfizer: Susceptible given first vaccine and protected S -> VP1_S
           (1-epsP_S)*nu1*.S,    #37. Pfizer: Susceptible given first vaccine and not protected S -> VPnot1_S
           epsP_R*nu1*.R1,    #38. Pfizer: Wild: Removed given first vaccine and protected by vaccine and prior infection R1 -> VP1_R
           (1-epsP_R)*nu1*.R1,    #39. Pfizer: Wild: Removed given first vaccine and not protected by vaccine or prior infection R1 -> VPnot1_R
           epsP_R*nu1*.R2,    #40. Pfizer: NL: Removed given first vaccine and protected by vaccine and prior infection R2 -> VP1_R
           (1-epsP_R)*nu1*.R2,    #41. Pfizer: NL: Removed given first vaccine and not protected by vaccine or prior infection R2 -> VPnot1_R
           nu2*.VP1_S,        #42. Pfizer: Susceptible Protected Vaccinated get second dose (remain protected) VP1_S -> VP2_S
           nu2*.VP1_R,        #43. Pfizer: removed Protected Vaccinated get second dose (remain protected) VP1_R -> VP2_R
           epsP_S2*nu2*.VPnot1_S,        #44. Pfizer: Susceptible UnProtected Vaccinated get second dose (get protected) VPnot1_S -> VP2_S
           (1-epsP_S2)*nu2*.VPnot1_S,       #45. Pfizer: Susceptible UnProtected Vaccinated get second dose (not protected) VPnot1_S -> VPnot2_S
           epsP_R2*nu2*.VPnot1_R,       #46. Pfizer: removed UnProtected Vaccinated get second dose (get protected) VPnot1_R -> VP2_R
           (1-epsP_R2)*nu2*.VPnot1_R,    #47. Pfizer: removed UnProtected Vaccinated get second dose (not protected) VPnot1_R -> VPnot2_R
           
           #JnJ vaccination
           epsJ_S*nuJ*.S,    # 48. JJ: Susceptible given first vaccine and protected S -> VJ_S
           (1-epsJ_S)*nuJ*.S,    # 49. JJ: Susceptible given first vaccine and not protected S -> VJnot_S
           epsJ_R*nuJ*.R1,    # 50. JJ: Wild: Removed given first vaccine and protected by vaccine and prior infection R1 -> VJ_R
           (1-epsJ_R)*nuJ*.R1,    # 51. JJ: Wild: Removed given first vaccine and not protected by vaccine or prior infection R1 -> VJnot_R
           epsJ_R*nuJ*.R2,    # 52. JJ: NL: Removed given first vaccine and protected by vaccine and prior infection R2 -> VJ_R
           (1-epsJ_R)*nuJ*.R2,    #53.  JJ: NL: Removed given first vaccine and not protected by vaccine or prior infection R2 -> VJnot_R
           
           #vaccine waning (protection from infection)
           omegaP_S1*.VP1_S,    #54. Pfizer: Susceptible Vaccine waning (1st dose) VP1_S -> VPnot1_S
           omegaP_R1*.VP1_R,    #55. Pfizer: Removed Vaccine waning (1st dose) VP1_R -> VPnot1_R
           omegaP_S2*.VP2_S,    #56. Pfizer: Susceptible Vaccine waning (2nd dose) VP2_S -> VPnot2_S
           omegaP_R2*.VP2_R,    #57. Pfizer: Removed Vaccine waning (2nd dose) VP2_R -> VPnot2_R
           omegaJ_S*.VJ_S,    #58. JJ: Susceptible Vaccine waning (1st dose) VJ_S -> VJnot_S
           omegaJ_R*.VJ_R,    #59. JJ: Removed Vaccine waning (1st dose) VJ_R -> VJnot_R
           
           #Breakthrough infections
            #from Pfizer 1st dose
           (1-((1-pa)*pss1*sevP_1))*Dfoi1VS*.VPnot1_S,    # 60. Pfizer Susceptible dose 1 Wild: Breakthrough infections: VPnot1_S -> Iam1
           (1-pa)*pss1*sevP_1*Dfoi1VS*.VPnot1_S,    #61. Pfizer Susceptible dose 1 Wild: Breakthrough infections: VPnot1_S -> Ip1
           (1-((1-pa)*psr*sevP_1R))*Dfoi1VR*.VPnot1_R,    #62. Pfizer Removed dose 1 Wild: Breakthrough infections: VPnot1_R -> Iam1
           (1-pa)*psr*sevP_1R*Dfoi1VR*.VPnot1_R,    #63. Pfizer Removed dose 1 Wild: Breakthrough infections: VPnot1_R -> Ip1
           (1-((1-pa)*pss2*sevP_1))*Dfoi2VS*.VPnot1_S,    #64. Pfizer Susceptible dose 1 NL: Breakthrough infections: VPnot1_S -> Iam2
           (1-pa)*pss2*sevP_1*Dfoi2VS*.VPnot1_S,    #65. Pfizer Susceptible dose 1 NL: Breakthrough infections: VPnot1_S -> Ip2
           (1-((1-pa)*psr*sevP_1Ri16))*Dfoi2VR*.VPnot1_R,    #66. Pfizer Removed dose 1 NL: Breakthrough infections: VPnot1_R -> Iam2
           (1-pa)*psr*sevP_1Ri16*Dfoi2VR*.VPnot1_R,    #67. Pfizer Removed dose 1 NL: Breakthrough infections: VPnot1_R -> Ip2
           
           (1-((1-pa)*pss1*sevP_2))*Dfoi1VS*.VPnot2_S,    # 68. Pfizer Susceptible dose 2 Wild: Breakthrough infections: VPnot2_S -> Iam1
           (1-pa)*pss1*sevP_2*Dfoi1VS*.VPnot2_S,    #69. Pfizer Susceptible dose 2 Wild: Breakthrough infections: VPnot2_S -> Ip1
           (1-((1-pa)*psr*sevP_2R))*Dfoi1VR*.VPnot2_R,    #70. Pfizer Removed dose 2 Wild: Breakthrough infections: VPnot2_R -> Iam1
           (1-pa)*psr*sevP_2R*Dfoi1VR*.VPnot2_R,    #71. Pfizer Removed dose 2 Wild: Breakthrough infections: VPnot2_R -> Ip1
           (1-((1-pa)*pss2*sevP_2))*Dfoi2VS*.VPnot2_S,    #72. Pfizer Susceptible dose 2 NL: Breakthrough infections: VPnot2_S -> Iam2
           (1-pa)*pss2*sevP_2*Dfoi2VS*.VPnot2_S,    # 73. Pfizer Susceptible dose 2 NL: Breakthrough infections: VPnot2_S -> Ip2
           (1-((1-pa)*psr*sevP_2Ri16))*Dfoi2VR*.VPnot2_R,    # 74. Pfizer Removed dose 2 NL: Breakthrough infections: VPnot2_R -> Iam2
           (1-pa)*psr*sevP_2Ri16*Dfoi2VR*.VPnot2_R,    #75. Pfizer Removed dose 2 NL: Breakthrough infections: VPnot2_R -> Ip2
           
           (1-((1-pa)*pss1*sevJ))*Dfoi1VS*.VJnot_S,    #  76. JJ Susceptible dose 1 Wild: Breakthrough infections: VJnot_S -> Iam1
           (1-pa)*pss1*sevJ*Dfoi1VS*.VJnot_S,    # 77. JJ Susceptible dose 1 Wild: Breakthrough infections: VJnot_S -> Ip1
           (1-((1-pa)*psr*sevJR))*Dfoi1VR*.VJnot_R,    #78. JJ Removed dose 1 Wild: Breakthrough infections: VJnot_R -> Iam1
           (1-pa)*psr*sevJR*Dfoi1VR*.VJnot_R,    #79. JJ Removed dose 1 Wild: Breakthrough infections: VJnot_R -> Ip1
           (1-((1-pa)*pss2*sevJ))*Dfoi2VS*.VJnot_S,    # 80. JJ Susceptible dose 1 NL: Breakthrough infections: VJnot_S -> Iam2
           (1-pa)*pss2*sevJ*Dfoi2VS*.VJnot_S,    # 81. JJ Susceptible dose 1 NL: Breakthrough infections: VJnot_S -> Ip2
           (1-((1-pa)*psr*sevJRi16))*Dfoi2VR*.VJnot_R,    # 82. JJ Removed dose 1 NL: Breakthrough infections: VJnot_R -> Iam2
           (1-pa)*psr*sevJRi16*Dfoi2VR*.VJnot_R,    #83. JJ Removed dose 1 NL: Breakthrough infections: VJnot_R -> Ip2
           
           #NL seed
           import,   #84. 55. NL: Seed  -> E2
           
           #Deaths after discharge 
           (1-pd2)*pdad*r4run*.ICU1,         #  85. 56. critical discharged ICU1 to D
           (1-pd2)*pdad*r4run*.ICU2,         #  86. 57. critical discharged ICU2 to D
           
           #Counter: Symptomatic incidence
           (1-pa)*gamma1*(.E1 + .Er1 ), #+ Dfoi1VS*.VPnot1_S + Dfoi1VR*.VPnot1_R + Dfoi1VS*.VPnot2_S + Dfoi1VR*.VPnot2_R + Dfoi1VS*.VJnot_S + Dfoi1VR*.VJnot_R  ), #  87. 58. Wild: Symptomatic incidence
           (1-pa)*gamma1*(.E2 + .Er2), # + Dfoi2VS*.VPnot1_S + Dfoi2VR*.VPnot1_R + Dfoi2VS*.VPnot2_S + Dfoi2VR*.VPnot2_R + Dfoi2VS*.VJnot_S + Dfoi2VR*.VJnot_R + Dfoi2VSi16*(.VP1_S + .VP2_S + .VJ_S + .VP1_R + .VP2_R + .VJ_R)), #  88. 59. NL: Symptomatic incidence
          
           #Delta seed
           importDelta, #89. 60. Delta: Seed ->E1
           foiR2cross/beh*.R2,         #  90. 61. reinfection R2 -> Er1
           
           #Counter: Actual vaccination
           nu1act*(.S + .R1 + .R2),  #91 Pfizer 1 dose: actual vaccination to FV_P1
           nu2act*(.VP1_S + .VP1_R + .VPnot1_S + .VPnot1_R), #92 Pfizer 2 dose: actual vaccination to FV_P2
           nuJact*(.S + .R1 + .R2), #93 JnJ 1 dose: actual vaccination to FV_J
           #Immune Escape Variant 
           importIEvar, #94. IE Variant: Seed ->E2
           betaRmove*.R2, #95. IE Variant: move Beta Removed to Wild/Delta Removed R2 -> R1
           #More breakthrough infections (NL only)
           (1-((1-pa)*pss2*sevP_1i16))*Dfoi2VSi16*.VP1_S,    #96. Pfizer Susceptible dose 1 NL: Breakthrough infections: VP1_S -> Iam2
           (1-pa)*pss2*sevP_1i16*Dfoi2VSi16*.VP1_S,    #97. Pfizer Susceptible dose 1 NL: Breakthrough infections: VP1_S -> Ip2
           (1-((1-pa)*pss2*sevP_2i16))*Dfoi2VSi16*.VP2_S,    #98. Pfizer Susceptible dose 2 NL: Breakthrough infections: VP2_S -> Iam2
           (1-pa)*pss2*sevP_2i16*Dfoi2VSi16*.VP2_S,    # 99. Pfizer Susceptible dose 2 NL: Breakthrough infections: VP2_S -> Ip2
           (1-((1-pa)*pss2*sevJi16))*Dfoi2VSi16*.VJ_S,    # 100. JJ Susceptible dose 1 NL: Breakthrough infections: VJ_S -> Iam2
           (1-pa)*pss2*sevJi16*Dfoi2VSi16*.VJ_S,    # 101. JJ Susceptible dose 1 NL: Breakthrough infections: VJ_S -> Ip2
         
           loss*(1-((1-pa)*pss2*sevP_1Ri18))*Dfoi2VR*.VP1_R,    #102. Pfizer Recovered dose 1 NL: Breakthrough infections: VP1_R -> Iam2
           loss*(1-pa)*pss2*sevP_1Ri18*Dfoi2VR*.VP1_R,    #103. Pfizer Recovered dose 1 NL: Breakthrough infections: VP1_R -> Ip2
           loss*(1-((1-pa)*pss2*sevP_2Ri18))*Dfoi2VR*.VP2_R,    #104. Pfizer Recovered dose 2 NL: Breakthrough infections: VP2_R -> Iam2
           loss*(1-pa)*pss2*sevP_2Ri18*Dfoi2VR*.VP2_R,    # 105. Pfizer Recovered dose 2 NL: Breakthrough infections: VP2_R -> Ip2
           loss*(1-((1-pa)*pss2*sevJRi18))*Dfoi2VR*.VJ_R,    # 106. JJ Recovered dose 1 NL: Breakthrough infections: VJ_R -> Iam2
           loss*(1-pa)*pss2*sevJRi18*Dfoi2VR*.VJ_R,    # 107. JJ Recovered dose 1 NL: Breakthrough infections: VJ_R -> Ip2
           
           ##Booster dose
           #get vaccinated
           nu3*.VP2_S, # 108. Pfizer: Susceptible Protected Vaccinated get third dose (remain protected) VP2_S -> VP3_S
           nu3*.VP2_R, # 109. Pfizer: removed Protected Vaccinated get third dose (remain protected) VP2_R -> VP3_R
           epsP_S3*nu3*.VPnot2_S, # 110. Pfizer: Susceptible UnProtected Vaccinated get third dose (get protected) VPnot2_S -> VP3_S
           (1-epsP_S3)*nu3*.VPnot2_S,  # 111. Pfizer: Susceptible UnProtected Vaccinated get third dose (not protected) VPnot2_S -> VPnot3_S
           epsP_R3*nu3*.VPnot2_R, # 112. Pfizer: removed UnProtected Vaccinated get third dose (get protected) VPnot2_R -> VP3_R
           (1-epsP_R3)*nu3*.VPnot2_R, # 113. Pfizer: removed UnProtected Vaccinated get third dose (not protected) VPnot2_R -> VPnot3_R
           nuJ2*.VJ_S, # 114. JJ: Susceptible Protected Vaccinated get second dose (remain protected) VJ_S -> VJ2_S
           nuJ2*.VJ_R, # 115. JJ: removed Protected Vaccinated get second dose (remain protected) VJ_R -> VJ2_R
           epsJ_S2*nuJ2*.VJnot_S, # 116. JJ: Susceptible UnProtected Vaccinated get second dose (get protected) VJnot_S -> VJ2_S
           (1-epsJ_S2)*nuJ2*.VJnot_S, # 117. JJ: Susceptible UnProtected Vaccinated get second dose (not protected) VJnot_S -> VJnot2_S
           epsJ_R2*nuJ2*.VJnot_R, # 118. JJ: removed UnProtected Vaccinated get second dose (get protected) VJnot_R -> VJ2_R
           (1-epsJ_R2)*nuJ2*.VJnot_R, # 119. JJ: removed UnProtected Vaccinated get second dose (not protected) VJnot_R -> VJnot2_R
           #waning protection from vaccination
           omegaP_S3*.VP3_S, # 120. Pfizer: Susceptible Vaccine waning (3rd dose) VP3_S -> VPnot3_S
           omegaP_R3*.VP3_R, # 121. Pfizer: Removed Vaccine waning (3rd dose) VP3_R -> VPnot3_R
           omegaJ_S2*.VJ2_S, # 122. JJ: Susceptible Vaccine waning (2nd dose) VJ2_S -> VJnot2_S
           omegaJ_R2*.VJ2_R, # 123. JJ: Removed Vaccine waning (2nd dose) VJ2_R -> VJnot2_R
           #Breakthrough infections from Pfizer 3rd dose
           (1-((1-pa)*pss1*sevP_3))*Dfoi1VS*.VPnot3_S, # 124 Pfizer Susceptible dose 3 Wild: Breakthrough infections: VPnot3_S -> Iam1
           (1-pa)*pss1*sevP_3*Dfoi1VS*.VPnot3_S, # 125 Pfizer Susceptible dose 3 Wild: Breakthrough infections: VPnot3_S -> Ip1
           (1-((1-pa)*psr*sevP_3R))*Dfoi1VR*.VPnot3_R,  # 126 Pfizer Removed dose 3 Wild: Breakthrough infections: VPnot3_R -> Iam1
           (1-pa)*psr*sevP_3R*Dfoi1VR*.VPnot3_R, # 127 Pfizer Removed dose 3 Wild: Breakthrough infections: VPnot3_R -> Ip1
           (1-((1-pa)*pss2*sevP_3))*Dfoi2VS*.VPnot3_S, # 128 Pfizer Susceptible dose 3 NL: Breakthrough infections: VPnot3_S -> Iam2
           (1-pa)*pss2*sevP_3*Dfoi2VS*.VPnot3_S,   # 129 Pfizer Susceptible dose 3 NL: Breakthrough infections: VPnot3_S -> Ip2
           (1-((1-pa)*psr*sevP_3R))*Dfoi2VR*.VPnot3_R, # 130 Pfizer Removed dose 3 NL: Breakthrough infections: VPnot3_R -> Iam2
           (1-pa)*psr*sevP_3R*Dfoi2VR*.VPnot3_R, # 131 Pfizer Removed dose 3 NL: Breakthrough infections: VPnot3_R -> Ip2
           #Breakthrough infections from JnJ 2nd dose
           (1-((1-pa)*pss1*sevJ2))*Dfoi1VS*.VJnot2_S, # 132 JJ Susceptible dose 2 Wild: Breakthrough infections: VJnot2_S -> Iam1
           (1-pa)*pss1*sevJ2*Dfoi1VS*.VJnot2_S, # 133 JJ Susceptible dose 2 Wild: Breakthrough infections: VJnot2_S -> Ip1
           (1-((1-pa)*psr*sevJ2R))*Dfoi1VR*.VJnot2_R, # 134 JJ Removed dose 2 Wild: Breakthrough infections: VJnot2_R -> Iam1
           (1-pa)*psr*sevJ2R*Dfoi1VR*.VJnot2_R, # 135 JJ Removed dose 2 Wild: Breakthrough infections: VJnot2_R -> Ip1
           (1-((1-pa)*pss2*sevJ2))*Dfoi2VS*.VJnot2_S, # 136 JJ Susceptible dose 2 NL: Breakthrough infections: VJnot2_S -> Iam2
           (1-pa)*pss2*sevJ2*Dfoi2VS*.VJnot2_S, # 137 JJ Susceptible dose 2 NL: Breakthrough infections: VJnot2_S -> Ip2
           (1-((1-pa)*psr*sevJ2R))*Dfoi2VR*.VJnot2_R, # 138 JJ Removed dose 2 NL: Breakthrough infections: VJnot2_R -> Iam2
           (1-pa)*psr*sevJ2R*Dfoi2VR*.VJnot2_R, # 139 JJ Removed dose 2 NL: Breakthrough infections: VJnot2_R -> Ip2
           #Counter: Actual vaccination continued
           nu3act*(.VP2_S + .VP2_R + .VPnot2_S + .VPnot2_R), #140 Pfizer 3 dose: actual vaccination to FV_P3
           nuJ2act*(.VJ_S + .VJ_R + .VJnot_S + .VJnot_R),  #141 JnJ 2 dose: actual vaccination to FV_J2
           # Recovery back to First vaccine state with hybrid immunity (opportunity to continue vaccination)
           r1*.IPam1, #142 Recovery: natural recovery IPam1 -> VP1_R
           (1-pd1)*r1*.IPp1, #143 Recovery: natural recovery IPp1 -> VP1_R
           r1*.IPam2, #144 Recovery: natural recovery IPam2 -> VP1_R
           (1-pd1)*r1*.IPp2, #145 Recovery: natural recovery IPp2 -> VP1_R
           r1*.IJam1, #146 Recovery: natural recovery IJam1 -> VJ_R
           (1-pd1)*r1*.IJp1, #147 Recovery: natural recovery IJp1 -> VJ_R
           r1*.IJam2, #148 Recovery: natural recovery IJam2 -> VJ_R
           (1-pd1)*r1*.IJp2, #149 Recovery: natural recovery IJp2 -> VJ_R
           #Death from BT severe infection for the Vaccinated
           pd1*r1*.IPp1, #150 Death in/out hospital:  IPp1 -> D
           pd1*r1*.IPp2, #151 Death in/out hospital:  IPp2 -> D
           pd1*r1*.IJp1, #152 Death in/out hospital:  IJp1 -> D
           pd1*r1*.IJp2, #153 Death in/out hospital:  IJp2 -> D
           #Seed BA4/5 Immune Escape Variant 
           importBA45var, #154. BA45 Variant: Seed ->Er1
           deltaRmove*.R1, #155. BA45 Variant: move Wild/Beta/Delta Removed to Omicron Removed R1 -> R2
           #More breakthrough infections (BA4/5 only)
           (1-((1-pa)*pss1*sevP_1i16))*Dfoi1VSi20*.VP1_S,    #156. Pfizer Susceptible dose 1 NL: Breakthrough infections: VP1_S -> Iam2
           (1-pa)*pss1*sevP_1i16*Dfoi1VSi20*.VP1_S,    #157. Pfizer Susceptible dose 1 NL: Breakthrough infections: VP1_S -> Ip2
           (1-((1-pa)*pss1*sevP_2i16))*Dfoi1VSi20*.VP2_S,    #158. Pfizer Susceptible dose 2 NL: Breakthrough infections: VP2_S -> Iam2
           (1-pa)*pss1*sevP_2i16*Dfoi1VSi20*.VP2_S,    # 159. Pfizer Susceptible dose 2 NL: Breakthrough infections: VP2_S -> Ip2
           (1-((1-pa)*pss1*sevJi16))*Dfoi1VSi20*.VJ_S,    # 160. JJ Susceptible dose 1 NL: Breakthrough infections: VJ_S -> Iam2
           (1-pa)*pss1*sevJi16*Dfoi1VSi20*.VJ_S,    # 161. JJ Susceptible dose 1 NL: Breakthrough infections: VJ_S -> Ip2

           loss*(1-((1-pa)*pss1*sevP_1Ri18))*Dfoi1VR*.VP1_R,    #162. Pfizer Recovered dose 1 NL: Breakthrough infections: VP1_R -> Iam2
           loss*(1-pa)*pss1*sevP_1Ri18*Dfoi1VR*.VP1_R,    #163. Pfizer Recovered dose 1 NL: Breakthrough infections: VP1_R -> Ip2
           loss*(1-((1-pa)*pss1*sevP_2Ri18))*Dfoi1VR*.VP2_R,    #164. Pfizer Recovered dose 2 NL: Breakthrough infections: VP2_R -> Iam2
           loss*(1-pa)*pss1*sevP_2Ri18*Dfoi1VR*.VP2_R,    # 165. Pfizer Recovered dose 2 NL: Breakthrough infections: VP2_R -> Ip2
           loss*(1-((1-pa)*pss1*sevJRi18))*Dfoi1VR*.VJ_R,    # 166. JJ Recovered dose 1 NL: Breakthrough infections: VJ_R -> Iam2
           loss*(1-pa)*pss1*sevJRi18*Dfoi1VR*.VJ_R,    # 167. JJ Recovered dose 1 NL: Breakthrough infections: VJ_R -> Ip2
           importhypIEvar, #168. Hypothetical IE Variant: Seed ->Er1
           importhypIEvar #169. Hypothetical IE Variant: Seed ->Er2
           
           
         ), dim=c(G, N, A)) %>% aperm(c(3,1,2))
         return(c(tranrates))
       })
}

#### Post Processing function ####
postproc <- function(parpro,out,tran) {
  with(as.list(c( parpro)),
       {
         # ************************************************************************************* #
         # for outputting the  time series for each patch
         # ************************************************************************************* #
         
         # Case outputs
         rem1_pred<-rem2_pred<-vac3delay_pred <- vacJ2delay_pred <- vac3_pred <- vacJ2_pred <- cvac3_pred <- cvacJ2_pred<- pop_pred<-sev2Prim_pred<-sev2BT_pred<-sev2Rein_pred<-sev1Prim_pred<-sev1BT_pred<-sev1Rein_pred<-escapeR_pred<-escapeV_pred<-non_rein_pred<-sus_pred<-inc1_pred<-inc2_pred<-Sinc1_pred<-Sinc2_pred<-reinf1_pred<-reinf2_pred<-xinf1_pred<-xinf2_pred<-btinf1_pred<-btinf2_pred <-btSinf1_pred<-btSinf2_pred <-btRinf1_pred<-btRinf2_pred <-prev1_pred<-prev2_pred<-hosp_beds<-icu_beds<-admitgen_pred<-admicu_pred<- asymild1_pred<-asymild2_pred<-sev1_pred<-sev2_pred<-sevnotT_pred<-deathgen_pred<-deathicu_pred<-deathuntrt_pred <-seroprev1_pred<-seroprev2_pred<-symp1_pred <- symp2_pred<-seroprevV_pred<-vac1_pred<-vac2_pred<-vacJ_pred<-vac1delay_pred<-vac2delay_pred<-vacJdelay_pred<-cvac1_pred<-cvac2_pred<-cvacJ_pred<-vtarget_pred<-array(0,c(length(out[,1]),G,N))
         for (n in 1:N){
           for (g in 1:G){
             sus_pred[,g,n]<-(out[,c(varind[c(1),g,n])+1]) # Susceptibles
             inc1_pred[,g,n]<-rowSums(tran[,c(traind[c(1, 15, 60:63, 68:71, 76:79, 90, 124:127, 132:135, 156:167),g,n])] )/365 # WILD: new total incidence (from naive and recovered)
             inc2_pred[,g,n]<-rowSums(tran[,c(traind[c(18, 32, 35, 64:67, 72:75, 80:83, 96:107, 128:131, 136:139),g,n])] )/365 # NL: new total incidence (from naive and recovered)
             Sinc1_pred[,g,n]<-(tran[,c(traind[c(1),g,n])] )/365 # WILD: new total incidence (from naive)
             Sinc2_pred[,g,n]<-(tran[,c(traind[c(18),g,n])] )/365 # NL: new total incidence (from naive)
             reinf1_pred[,g,n]<-(tran[,c(traind[c(15),g,n])] )/365 # WILD: reinfection + Delta reinfections
             reinf2_pred[,g,n]<-(tran[,c(traind[c(32),g,n])] )/365 # NL: reinfection 
             xinf1_pred[,g,n]<-(tran[,c(traind[c( 90),g,n])] )/365 # WILD: cross infections
             xinf2_pred[,g,n]<-(tran[,c(traind[c(35),g,n])] )/365 # NL: cross infections
             btinf1_pred[,g,n]<-rowSums(tran[,c(traind[c(60:63, 68:71, 76:79, 124:127, 132:135, 156:167),g,n])] )/365 # WILD: breakthrough incidence
             btinf2_pred[,g,n]<-rowSums(tran[,c(traind[c(64:67, 72:75, 80:83, 96:107, 128:131, 136:139),g,n])] )/365 # NL: breakthrough incidence
             btSinf1_pred[,g,n]<-rowSums(tran[,c(traind[c(60:61, 68:69, 76:77, 124:125,132:133, 156:161 ),g,n])] )/365 # WILD: breakthrough incidence from Susceptible
             btSinf2_pred[,g,n]<-rowSums(tran[,c(traind[c(64:65, 72:73, 80:81, 96:101, 128:129,136:137),g,n])] )/365 # NL: breakthrough incidence from Susceptible
             btRinf1_pred[,g,n]<-rowSums(tran[,c(traind[c(62:63, 70:71, 78:79,126:127, 134:135, 162:167),g,n])] )/365 # WILD: breakthrough incidence from Recovered
             btRinf2_pred[,g,n]<-rowSums(tran[,c(traind[c(66:67, 74:75, 82:83, 102:107, 130:131, 138:139 ),g,n])] )/365 # NL: breakthrough incidence from Recovered
             prev1_pred[,g,n]<-rowSums(out[,c(varind[c(2:8,10),g,n])+1]) #WILD: total prevalence (E+all infected states)
             prev2_pred[,g,n]<-rowSums(out[,c(varind[c(12:18,20),g,n])+1]) #NL: total prevalence (E+all infected states)
             hosp_beds[,g,n]<-rowSums(out[,c(varind[c(7,17),g,n])+1]) #gen beds in use
             icu_beds[,g,n]<-rowSums(out[,c(varind[c(8,18),g,n])+1]) #icu beds in use
             admitgen_pred[,g,n]<-rowSums(tran[,c(traind[c(6, 23),g,n])])/365 #new hosp admissions (severe cases into hospital)
             admicu_pred[,g,n]<-rowSums(tran[,c(traind[c(7, 24),g,n])])/365 #new ICU admissions (at time of entry into hosp)
             asymild1_pred[,g,n]<-rowSums(tran[,c(traind[c(2,16, 60, 62, 68, 70,  76, 78, 124, 126, 132, 134),g,n])])/365 #WILD: new Asym/Mild infections 
             asymild2_pred[,g,n]<-rowSums(tran[,c(traind[c(19, 33, 64, 66, 72, 74, 80, 82, 96, 98, 100, 102, 104, 106, 128, 130, 136, 138),g,n])])/365 #NL: new Asym/Mild infections
             sev1_pred[,g,n]<-rowSums(tran[,c(traind[c(3, 17, 61, 63, 69, 71, 77, 79, 125, 127, 133, 135),g,n])])/365 # WILD: new severe +critical
             sev2_pred[,g,n]<-rowSums(tran[,c(traind[c(20, 34, 65, 67, 73, 75, 81, 83, 97, 99, 101, 103, 105, 107, 129, 131, 137, 139),g,n])])/365 # NL severe +critical
             sev1Prim_pred[,g,n]<-(tran[,c(traind[c(3),g,n])])/365 # WILD: new severe +critical Primary infections
             sev1BT_pred[,g,n]<-rowSums(tran[,c(traind[c(61, 63, 69, 71, 77, 79,125, 127, 133, 135 ),g,n])])/365 # WILD: new severe +critical Breakthrough Infections
             sev1Rein_pred[,g,n]<-(tran[,c(traind[c(17),g,n])])/365 # WILD: new severe +critical Reinfections
             sev2Prim_pred[,g,n]<-(tran[,c(traind[c(20),g,n])])/365 # NL: new severe +critical Primary infections
             sev2BT_pred[,g,n]<-rowSums(tran[,c(traind[c(65, 67, 73, 75, 81, 83, 97, 99, 101, 103, 105, 107, 129, 131, 137, 139),g,n])])/365 # NL: new severe +critical Breakthrough Infections
             sev2Rein_pred[,g,n]<-(tran[,c(traind[c(34),g,n])])/365 # NL: new severe +critical Reinfections
             sevnotT_pred[,g,n]<- rowSums(tran[,c(traind[c(4,21),g,n])])/365 # Severe untreated (WILD + NL)
               
             deathgen_pred[,g,n]<-rowSums(tran[,c(traind[c(12,29,150:153),g,n])])/365 #new  deaths general ward + BT sev from vacc (die)
             deathicu_pred[,g,n]<-rowSums(tran[,c(traind[c(14,31),g,n])])/365 #new  deaths ICU
             deathuntrt_pred[,g,n]<-rowSums(tran[,c(traind[c(10,27, 85, 86),g,n])])/365 #new  deaths untreated
             seroprev1_pred[,g,n]<-rowSums(out[,c(varind[c(2:10,46,47,50,51),g,n])+1]) #WILD:  seroprevalence (R + Infected states)
             seroprev2_pred[,g,n]<-rowSums(out[,c(varind[c(12:20,48,49,52,53),g,n])+1]) #NL:  seroprevalence (R + Infected states)
             seroprevV_pred[,g,n]<-rowSums(out[,c(varind[c(23, 24, 27, 28, 31, 32, 38, 39, 42, 43),g,n])+1]) #MiX:  seroprevalence (Vaccinated states)
             symp1_pred[,g,n]<-(tran[,c(traind[c(87),g,n])] )/365 # WILD: total symptomatic cases
             symp2_pred[,g,n]<-(tran[,c(traind[c(88),g,n])] )/365 # NL:total symptomatic cases
             vac1delay_pred[,g,n]<-rowSums(tran[,c(traind[c(36:41),g,n])])/365 #Pfizer 1: new  vaccinations
             vac2delay_pred[,g,n]<-rowSums(tran[,c(traind[c(42:47),g,n])])/365 #Pfizer 2: new  vaccinations
             vac3delay_pred[,g,n]<-rowSums(tran[,c(traind[c(108:113),g,n])])/365 #Pfizer 3: new  vaccinations
             vacJdelay_pred[,g,n]<-rowSums(tran[,c(traind[c(48:53),g,n])])/365 #JnJ: new  vaccinations
             vacJ2delay_pred[,g,n]<-rowSums(tran[,c(traind[c(114:119),g,n])])/365 #JnJ: new  vaccinations
             vac1_pred[,g,n]<-(tran[,c(traind[c(91),g,n])])/365 #Pfizer 1: new  vaccinations
             vac2_pred[,g,n]<-(tran[,c(traind[c(92),g,n])])/365 #Pfizer 2: new  vaccinations
             vac3_pred[,g,n]<-(tran[,c(traind[c(140),g,n])])/365 #Pfizer 3: new  vaccinations
             vacJ_pred[,g,n]<-(tran[,c(traind[c(93),g,n])])/365 #JnJ: new  vaccinations
             vacJ2_pred[,g,n]<-(tran[,c(traind[c(141),g,n])])/365 #JnJ 2: new  vaccinations
             cvac1_pred[,g,n]<-(out[,c(varind[c(33),g,n])+1]) #cumulative Pfizer 1st doses
             cvac2_pred[,g,n]<-(out[,c(varind[c(34),g,n])+1]) #cumulative Pfizer 2nd doses
             cvac3_pred[,g,n]<-(out[,c(varind[c(44),g,n])+1]) #cumulative Pfizer 3rd doses
             cvacJ_pred[,g,n]<-(out[,c(varind[c(35),g,n])+1]) #cumulative JnJ 1st doses
             cvacJ2_pred[,g,n]<-(out[,c(varind[c(45),g,n])+1]) #cumulative JnJ 2nd doses
             vtarget_pred[,g,n]<-rowSums(out[,c(varind[c(1, 9, 19),g,n])+1]) #target population to receive first vaccination
             non_rein_pred[,g,n]<-rowSums(out[,c(varind[c(2:8,10,12:18,20, 46:53),g,n])+1]) #NL: total prevalence (E+all infected states)
             escapeR_pred[,g,n]<-rowSums(out[,c(varind[c(9,19),g,n])+1]) #Removed from Infectiousness
             escapeV_pred[,g,n]<-rowSums(out[,c(varind[c(21,23,25,27,29,31,36,38,40,42),g,n])+1]) #Vaccine Protected States
             pop_pred[,g,n]<-rowSums(out[,c(varind[covpop,g,n])+1]) #alive population
             rem1_pred[,g,n]<-(out[,c(varind[c(9),g,n])+1]) # Wild/Delta Removed/Recovered 
             rem2_pred[,g,n]<-(out[,c(varind[c(19),g,n])+1]) # Beta/Omicron Removed/Recovered
             
           }
         }

                  return(list(
                     inc1_pred,    #1
                     inc2_pred,     #2
                     reinf1_pred,   #3
                     reinf2_pred,     #4
                     btinf1_pred,     #5
                     btinf2_pred,     #6
                     prev1_pred,  #7
                     prev2_pred,  #8
                     hosp_beds,  #9
                     icu_beds, #10
                     admitgen_pred,  #11
                     admicu_pred, #12
                     asymild1_pred, #13
                     asymild2_pred,  #14
                     sev1_pred,   #15
                     sev2_pred,  #16
                     deathgen_pred, #17
                     deathicu_pred,  #18
                     deathuntrt_pred, #19
                     seroprev1_pred,   #20
                     seroprev2_pred,  #21
                     symp1_pred,   #22
                     symp2_pred,   #23
                     seroprevV_pred, #24
                     vac1delay_pred, #25
                     vac2delay_pred, #26
                     vacJdelay_pred, #27
                     vac1_pred, #28
                     vac2_pred, #29
                     vacJ_pred, #30,
                     cvac1_pred, #31
                     cvac2_pred, #32
                     cvacJ_pred, #33
                     vtarget_pred, #34
                     xinf1_pred,   #35
                     xinf2_pred,     #36
                     sus_pred, #37
                     non_rein_pred, #38
                     escapeR_pred, #39
                     btSinf1_pred,     #40
                     btSinf2_pred,     #41 
                     btRinf1_pred,     #42
                     btRinf2_pred,     #43
                     Sinc1_pred,    # 44
                     Sinc2_pred,     # 45
                     escapeV_pred, #46
                     sev1Prim_pred,  #47
                     sev1BT_pred, #48
                     sev1Rein_pred, #49
                     sev2Prim_pred, #50
                     sev2BT_pred, #51
                     sev2Rein_pred, #52
                     sevnotT_pred, #53
                     pop_pred, #54
                     vac3delay_pred, #55
                     vacJ2delay_pred, #56
                     vac3_pred, #57
                     vacJ2_pred, #58,
                     cvac3_pred, #59
                     cvacJ2_pred, #60
                     rem1_pred, #61
                     rem2_pred #62
                      
         ))
         
       })
}

ti<-1


#### ODE Solver ####
# ************************************************************************************* #
# ************************************************************************************* #

epiModel<-function(t,state, parode,input, scenario) 
{ 
  
  with(as.list(c(state, parode)),
       {
         
         #   # ************************************************************************************* #
         #   # define variables
         #   # ************************************************************************************* #
         
         Z=state
         
         # rates of change
         ti<-1
         transit<-covrates(Z[1:V],input,parode,Z[V+1],ti, scenario)  
         
         if (sum(is.na(transit))>0)  {
           stop("transit NA   ",Z[V+1], "                                      ", 
                as.data.frame(transit))
         }
         
              transit2<-transit# opportunity to add stochasticity: apply(cbind((rnbinom(L, mu=transit, size=4)),rep(0,L)), 1, FUN=max, na.rm=T)
         
        
         eq<-rep(0.0, V)
         
         eq<-EQ(L, N, eq, transit2,transitionsiu1,transitionsiu2,transitionsiv1,transitionsiv2)
         
         eq[V+1]<-1
         
         dZ<-eq
         
         # return the rate of change
         list(c(dZ))
       }
  ) 
  # end with(as.list ...
}

#*************************************************************************
#*************************************************************************

#### Model Run Function ####


run <- function(parrun, scenario, p){
  
  # ************************************************************************************* #
   
  cmpopinitrun <- cmpopinit[,p]; hcwpopinitrun <- hcwpopinit[,p]; EEpopinitrun <- EEpopinit[,p]
  cmdeathinitrun <- cmdeathinit[,p]; hcwdeathinitrun <- hcwdeathinit[,p]; EEdeathinitrun <- EEdeathinit[,p]
  cmhospinitrun <- cmhospinit[,p]; hcwhospinitrun <- hcwhospinit[,p]; EEhospinitrun <- EEhospinit[,p]
  cmicuinitrun <- cmicuinit[,p]; hcwicuinitrun <- hcwicuinit[,p]; EEicuinitrun <- EEicuinit[,p]
  cmcaseinitrun <- cmcaseinit[,p] ; hcwcaseinitrun <- hcwcaseinit[,p]; EEcaseinitrun <- EEcaseinit[,p]
  
  cmpoprun <- cmpop[,p+1]; hcwpoprun <- hcwpop[,p+1]; EEpoprun <- EEpop[,p+1]
  # define initial conditions
  initcondrun<-rep(0,B*G*N)

    #HCW
        initcondrun[varind[3,,1]]<- (1-((1-parrun$pa)*parrun$pss1))*seedfac*hcwcaseinitrun #Asymp
        initcondrun[varind[4,,1]]<- ((1-parrun$pa)*parrun$pss1)*seedfac*hcwcaseinitrun #PreSymp
        initcondrun[varind[7,,1]]<- hcwhospinitrun # Hospital
        initcondrun[varind[8,,1]]<- hcwicuinitrun #ICU
        initcondrun[varind[9,,1]]<- hcwpopinitrun #Removed
        initcondrun[varind[11,,1]]<- hcwdeathinitrun #Dead
        initcondrun[varind[1,,1]]<- unlist(hcwpoprun) - (initcondrun[varind[3,,1]]+initcondrun[varind[4,,1]]+initcondrun[varind[7,,1]]+initcondrun[varind[8,,1]]+initcondrun[varind[9,,1]]) #Susceptible
    
     
  #CM
  
    initcondrun[varind[3,,2]]<- (1-((1-parrun$pa)*parrun$pss1))*seedfac*cmcaseinitrun #Asymp
    initcondrun[varind[4,,2]]<- ((1-parrun$pa)*parrun$pss1)*seedfac*cmcaseinitrun #PreSymp
    initcondrun[varind[7,,2]]<- cmhospinitrun # Hospital
    initcondrun[varind[8,,2]]<- cmicuinitrun #ICU
    initcondrun[varind[9,,2]]<- cmpopinitrun #Removed
    initcondrun[varind[11,,2]]<- cmdeathinitrun #Dead
    
    initcondrun[varind[1,,2]]<-unlist(cmpoprun) - (initcondrun[varind[3,,2]]+initcondrun[varind[4,,2]]+initcondrun[varind[7,,2]]+initcondrun[varind[8,,2]]+initcondrun[varind[9,,2]]) #Susceptible
  
  
  #EE
    initcondrun[varind[3,,3]]<- (1-((1-parrun$pa)*parrun$pss1))*seedfac*EEcaseinitrun #Asymp
    initcondrun[varind[4,,3]]<- ((1-parrun$pa)*parrun$pss1)*seedfac*EEcaseinitrun #PreSymp
    initcondrun[varind[7,,3]]<- EEhospinitrun # Hospital
    initcondrun[varind[8,,3]]<- EEicuinitrun #ICU
    initcondrun[varind[9,,3]]<- EEpopinitrun #Removed
    initcondrun[varind[11,,3]]<- EEdeathinitrun #Dead
    
    initcondrun[varind[1,,3]]<-unlist(EEpoprun) - (initcondrun[varind[3,,3]]+initcondrun[varind[4,,3]]+initcondrun[varind[7,,3]]+initcondrun[varind[8,,3]]+initcondrun[varind[9,,3]]) #Susceptible
  

  initoderun<-initcondrun
  staterun <- c(initoderun,0)
  ti<-1
  inp<-inputs(parrun, scenario)
  transitrun <- covrates(initoderun,inp,parrun,0,ti,scenario )
  
 # transitrun <- covrates(initoderun,inp,parrun,0,270/365,scenario )
  
  #
  # # SOLVE THE ODEs and get output
  timesrun <- seq(0,tyears , by = dtout) # Model run time    tyears
  #Solve ODE
  outoderun <- ode(y = staterun, times = timesrun, func = epiModel, parms = parrun, method  = "euler", input=inp,scenario=scenario )
  # Compute transitions at each time step
  tranoderun<-matrix(0,nrow=length(outoderun[,1]),ncol=length(transitions[,1]))
  for (ti in 1:(tsteps+1)){ ##used to be tsteps +1 - why is it breaking now?
    tranoderun[ti,]<-t(covrates(outoderun[ti,2:(1+V)],inp,parrun,0,ti,scenario ))
  }
  
  #Compute outputs
  ppout<-postproc(parrun,outoderun,tranoderun)
  modeltimes<-outoderun[,1]+startyear
  inc1_pred_ode<-ppout[[1]]
  inc2_pred_ode<-ppout[[2]]  
  reinf1_pred_ode<-ppout[[3]]
  reinf2_pred_ode<-ppout[[4]]
  btinf1_pred_ode<-ppout[[5]]
  btinf2_pred_ode<-ppout[[6]]
  prev1_pred_ode<-ppout[[7]]
  prev2_pred_ode<-ppout[[8]]
  hosp_beds_ode<-ppout[[9]]
  icu_beds_ode<-ppout[[10]]
  admitgen_pred_ode<-ppout[[11]]
  admiticu_pred_ode<-ppout[[12]] 
  asymild1_pred_ode<-ppout[[13]]
  asymild2_pred_ode<-ppout[[14]]
  sev1_pred_ode<-ppout[[15]]
  sev2_pred_ode<-ppout[[16]]
  deathgen_pred_ode<-ppout[[17]]
  deathicu_pred_ode<-ppout[[18]]
  deathuntrt_pred_ode<-ppout[[19]]
  seroprev1_pred_ode<-ppout[[20]]
  seroprev2_pred_ode<-ppout[[21]]
  symp1_pred_ode<-ppout[[22]]
  symp2_pred_ode<-ppout[[23]]
  seroprevV_pred_ode<-ppout[[24]]
  vac1delay_pred_ode<-ppout[[25]]
  vac2delay_pred_ode<-ppout[[26]]
  vacJdelay_pred_ode<-ppout[[27]]
  vac1_pred_ode<-ppout[[28]]
  vac2_pred_ode<-ppout[[29]]
  vacJ_pred_ode<-ppout[[30]]
  cvac1_pred_ode<-ppout[[31]]
  cvac2_pred_ode<-ppout[[32]]
  cvacJ_pred_ode<-ppout[[33]]
  vtarget_pred_ode<-ppout[[34]]
  xinf1_pred_ode<-ppout[[35]]
  xinf2_pred_ode<-ppout[[36]]
  sus_pred_ode<-ppout[[37]]
  non_rein_pred_ode<-ppout[[38]]
  escapeR_pred_ode<-ppout[[39]]
  btSinf1_pred_ode<-ppout[[40]]
  btSinf2_pred_ode<-ppout[[41]]
  btRinf1_pred_ode<-ppout[[42]]
  btRinf2_pred_ode<-ppout[[43]]
  Sinc1_pred_ode<-ppout[[44]]
  Sinc2_pred_ode<-ppout[[45]]  
  escapeV_pred_ode<-ppout[[46]]
  sev1Prim_pred_ode<-ppout[[47]]
  sev1BT_pred_ode<-ppout[[48]]
  sev1Rein_pred_ode<-ppout[[49]]
  sev2Prim_pred_ode<-ppout[[50]]
  sev2BT_pred_ode<-ppout[[51]]
  sev2Rein_pred_ode<-ppout[[52]]
  sevnotT_pred_ode<-ppout[[53]]
  pop_pred_ode<-ppout[[54]]
  vac3delay_pred_ode<-ppout[[55]]
  vacJ2delay_pred_ode<-ppout[[56]]
  vac3_pred_ode<-ppout[[57]]
  vacJ2_pred_ode<-ppout[[58]]
  cvac3_pred_ode<-ppout[[59]]
  cvacJ2_pred_ode<-ppout[[60]]
  rem1_pred_ode<-ppout[[61]]
  rem2_pred_ode<-ppout[[62]]
  
  inc_pred_ode<-inc1_pred_ode+inc2_pred_ode
  seroprev_pred_ode <- seroprev1_pred_ode + seroprev2_pred_ode + seroprevV_pred_ode
  propNL_pred_ode <- inc2_pred_ode / inc_pred_ode #when this is collapsed, it will be wrong. gets redefined in plot
  hospdeath_pred_ode <- deathgen_pred_ode + deathicu_pred_ode
  totdeath_pred_ode <- hospdeath_pred_ode + deathuntrt_pred_ode
  reinf_pred_ode <- reinf1_pred_ode + reinf2_pred_ode
  symp_pred_ode <- symp1_pred_ode + symp2_pred_ode
  admall_pred_ode <- admiticu_pred_ode + admitgen_pred_ode
  sev_pred_ode <- sev1_pred_ode + sev2_pred_ode
  all_beds_ode <- hosp_beds_ode + icu_beds_ode
  vac_pred_ode <- vac1_pred_ode + vac2_pred_ode + vac3_pred_ode + vacJ_pred_ode + vacJ2_pred_ode
  vacP_pred_ode <- vac1_pred_ode + vac2_pred_ode + vac3_pred_ode
  fullvac_pred_ode <- vac2_pred_ode + vacJ_pred_ode
  indvac_pred_ode <- vac1_pred_ode + vacJ_pred_ode
  indvacdelay_pred_ode <- vac1delay_pred_ode + vacJdelay_pred_ode
  escape_pred_ode<- escapeR_pred_ode+escapeV_pred_ode
  asym1_pred_ode<- pars$pa*(symp1_pred_ode/(1-pars$pa)) #asymild1_pred_ode +sev1_pred_ode - symp1_pred_ode
  asym2_pred_ode<- pars$pa*(symp2_pred_ode/(1-pars$pa)) #asymild2_pred_ode +sev2_pred_ode - symp2_pred_ode
  asym_pred_ode<- asym1_pred_ode + asym2_pred_ode
  mild1_pred_ode<- asymild1_pred_ode-asym1_pred_ode
  mild2_pred_ode<- asymild2_pred_ode-asym2_pred_ode
  mild_pred_ode<- mild1_pred_ode + mild2_pred_ode
  
  COVout<-list(#times = modeltimes, #1
               inc1 = as.data.table(inc1_pred_ode),#2
               inc2 = as.data.table(inc2_pred_ode),#3
               reinf1 = as.data.table(reinf1_pred_ode) , #4
               reinf2 = as.data.table(reinf2_pred_ode), #5
               btinf1 = as.data.table(btinf1_pred_ode), #6
               btinf2 = as.data.table(btinf2_pred_ode), #7
               prev1 = as.data.table(prev1_pred_ode), #8
               prev2 = as.data.table(prev2_pred_ode), #9
               hosp = as.data.table(hosp_beds_ode),#10
               icu = as.data.table(icu_beds_ode),#11
               admgen = as.data.table(admitgen_pred_ode),#12
               admicu = as.data.table(admiticu_pred_ode),#13
               asymild1 = as.data.table(asymild1_pred_ode), #14
               asymild2 = as.data.table(asymild2_pred_ode), #15
               sev1 = as.data.table(sev1_pred_ode), #16
               sev2 = as.data.table(sev2_pred_ode), #17
               deathgen = as.data.table(deathgen_pred_ode),#18
               deathicu = as.data.table(deathicu_pred_ode),#19
               deathuntrt = as.data.table(deathuntrt_pred_ode),#20
               seroprev1 = as.data.table(seroprev1_pred_ode),#21
               seroprev2 = as.data.table(seroprev2_pred_ode),#22
               totinc = as.data.table(inc_pred_ode), # #23
               totsp = as.data.table(seroprev_pred_ode),  #24
               propNL = as.data.table(propNL_pred_ode),  #245
               hospdeath = as.data.table(hospdeath_pred_ode),  #26
               totdeath = as.data.table(totdeath_pred_ode),  #27
               reinf = as.data.table(reinf_pred_ode), #28
               sympinc1 = as.data.table(symp1_pred_ode),#29
               sympinc2 = as.data.table(symp2_pred_ode), #30
               sympinc = as.data.table(symp_pred_ode), #31
               admall = as.data.table(admall_pred_ode), #32
               sev = as.data.table(sev_pred_ode), #33
               all_beds = as.data.table(all_beds_ode), #34
               seroprevV = as.data.table(seroprevV_pred_ode), #35
               vac1delay = as.data.table(vac1delay_pred_ode), #36
               vac2delay = as.data.table(vac2delay_pred_ode), #37
               vac3delay = as.data.table(vac3delay_pred_ode), #37
               vacJdelay = as.data.table(vacJdelay_pred_ode), #38
               vacJ2delay = as.data.table(vacJ2delay_pred_ode), #38
               vac1 = as.data.table(vac1_pred_ode), #39
               vac2 = as.data.table(vac2_pred_ode), #40
               vac3 = as.data.table(vac3_pred_ode), #40
               vacJ = as.data.table(vacJ_pred_ode), #41
               vacJ2 = as.data.table(vacJ2_pred_ode), #41
               vacP = as.data.table(vacP_pred_ode), #42
               cvac1 = as.data.table(cvac1_pred_ode), #43
               cvac2 = as.data.table(cvac2_pred_ode), #44
               cvac3 = as.data.table(cvac3_pred_ode), #44
               cvacJ = as.data.table(cvacJ_pred_ode), #45
               cvacJ2 = as.data.table(cvacJ2_pred_ode), #45
               vac = as.data.table(vac_pred_ode), #46
               fullvac = as.data.table(fullvac_pred_ode), #47
               indvac = as.data.table(indvac_pred_ode), #48
               indvacdelay = as.data.table(indvacdelay_pred_ode), #48
               vtarget = as.data.table(vtarget_pred_ode), #49
               xinf1 = as.data.table(xinf1_pred_ode) , #51
               xinf2 = as.data.table(xinf2_pred_ode), #52
               sus = as.data.table(sus_pred_ode), #53
               non_reinfectable = as.data.table(non_rein_pred_ode), #54
               escapable = as.data.table(escape_pred_ode), #55
               Rescapable = as.data.table(escapeR_pred_ode), #55
               Vescapable = as.data.table(escapeV_pred_ode), #55
               btSinf1 = as.data.table(btSinf1_pred_ode), #56
               btSinf2 = as.data.table(btSinf2_pred_ode), #57
               btRinf1 = as.data.table(btRinf1_pred_ode), #58
               btRinf2 = as.data.table(btRinf2_pred_ode), #59
               Sinc1 = as.data.table(Sinc1_pred_ode), #60
               Sinc2 = as.data.table(Sinc2_pred_ode), #61
               sev1Prim = as.data.table(sev1Prim_pred_ode), #62
               sev1BT = as.data.table(sev1BT_pred_ode), #63
               sev1Rein = as.data.table(sev1Rein_pred_ode), #64
               sev2Prim = as.data.table(sev2Prim_pred_ode), #65
               sev2BT = as.data.table(sev2BT_pred_ode), #66
               sev2Rein = as.data.table(sev2Rein_pred_ode), #67
               sevnotT = as.data.table(sevnotT_pred_ode), #68
               asym1 = as.data.table(asym1_pred_ode), #69
               asym2 = as.data.table(asym2_pred_ode), #70
               asym = as.data.table(asym_pred_ode), #71
               mild1 = as.data.table(mild1_pred_ode), #72
               mild2 = as.data.table(mild2_pred_ode), #73
               mild = as.data.table(mild_pred_ode), #74
               rem1 = as.data.table(rem1_pred_ode), #75
               rem2 = as.data.table(rem2_pred_ode), #76
               pop = as.data.table(pop_pred_ode) #77
               
        #        ode = outoderun, #22
        #        tran = tranoderun #23
  )
  
  COVout_Combined <- rbindlist(COVout, use.names = T, idcol=T)
  names(COVout_Combined) <- c('variable', 'day','age', 'subpop', 'value' )
  
 # return(list(ode = outoderun,tran = tranoderun )) #need for safety checks
  return(COVout_Combined)
}


#### Scenario definition ####
#i2: switch on NPIs
#i3: switch on beh resp to mortality
#i4: switch on beh reso to cases
#i5: seasonality
#i6: switch on vaccination (indirect)
#i7: Limited NPIs
#i8: Limited NPIS with response
#i9: Delta variant (increase transmissibility)
#i10: switch on vaccination 
#i13: ST awareness linked to NPIs
#i14: Vaccine future scenario: 70% FV by 31/01/2022
#i15: Vaccine future scenario: 70% IV by 31/03/2022
#i16: Immune escape variant (delta transmissabilty, 25% immune loss)
#i17: Vaccine future scenario: 90% IV by 31/03/2022
#i18: Additional loss of protection through IE variant: Vaccinated Protected & Previously infected
#sc19: No vaccine scenario with immune variant
#i20: BA4/5 variant (Omicron transmissibility + increased Immune loss )
#sc21: No vaccine scenario with BA4/5 variant
#i22: Vaccine future scenario: 60% IV by 31/12/2024
#i23: Hypothetical IE variant (Omicron transmissibility + Immune loss )
#i24: loss of severe protection from infection and vaccine derived immunity
#i25: hybrid immunity holds out against fast waning and severe loss
scenario<-matrix(0, 30, 30)
scenario[1,]<-0   #no intervention
scenario[2,2]<-1  #i2 NPIs defined by google residential mobility
scenario[3,2]<-scenario[3,3]<-1  #i3 behavioural response to total mortality + NPIs
scenario[4,2]<-scenario[4,4]<-1  #i4 behavioural response to symptomatic incidence + NPIs
scenario[5,2]<-scenario[5,3]<-scenario[5,5]<-1  #i3, i5 behavioural response to total mortality + NPIs +seasonality
scenario[6,2]<-scenario[6,3]<-scenario[6,5]<-scenario[6,6]<-1  #i6  vaccination switch
scenario[7,2]<-scenario[7,3]<-scenario[7,5]<-scenario[7,7]<-1  #i7  Limited NPIs with response to mortality
scenario[8,2]<-scenario[8,3]<-scenario[8,5]<-scenario[8,7]<-scenario[8,8]<-1  #i8  Limited NPIs and NO response to mortality
scenario[9,2]<-scenario[9,3]<-scenario[9,5]<-scenario[9,9]<-1 #i2/3/5/9 BHM + NPI + seas+ Delta variant
scenario[10,2]<-scenario[10,3]<-scenario[10,5]<-scenario[10,9]<-scenario[10,10]<-1 #i2/3/5/9/10 BHM + NPI + seas+ Delta variant+ vaccination
scenario[11,2]<-scenario[11,3]<-scenario[11,5]<-scenario[11,8]<-scenario[11,9]<-scenario[11,10]<-1 #i2/3/5/8/9/10 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase
scenario[12,2]<-scenario[12,3]<-scenario[12,5]<-scenario[12,8]<-scenario[12,9]<-1 #i2/3/5/8/9 BHM + NPI + seas+ Delta variant + beh_resp increase NO VACCINATION
scenario[13,2]<-scenario[13,3]<-scenario[13,5]<-scenario[13,9]<-scenario[13,10]<-scenario[13,13]<-1 #i2/3/5/9/10/13 BHM + NPI + seas+ Delta variant + vaccination + dynamic beh_resp increase
scenario[14,2]<-scenario[14,3]<-scenario[14,5]<-scenario[14,8]<-scenario[14,9]<-scenario[14,10]<-scenario[14,14]<-1 #i2/3/5/8/9/10/14 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + FV70
scenario[15,2]<-scenario[15,3]<-scenario[15,5]<-scenario[15,8]<-scenario[15,9]<-scenario[15,10]<-scenario[15,15]<-1 #i2/3/5/8/9/10/15 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IV70
scenario[16,2]<-scenario[16,3]<-scenario[16,5]<-scenario[16,8]<-scenario[16,9]<-scenario[16,10]<-scenario[16,15]<-scenario[16,16]<-1 #i2/3/5/8/9/10/15/16 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IV70 + IEvariant
scenario[17,2]<-scenario[17,3]<-scenario[17,5]<-scenario[17,8]<-scenario[17,9]<-scenario[17,10]<-scenario[17,17]<-1 #i2/3/5/8/9/10/17 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IV90
scenario[18,2]<-scenario[18,3]<-scenario[18,5]<-scenario[18,8]<-scenario[18,9]<-scenario[18,10]<-scenario[18,15]<-scenario[18,16]<-scenario[18,18]<-1 #i2/3/5/8/9/10/15/16/18 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IV70 + IEvariant + additonal loss
scenario[19,2]<-scenario[19,3]<-scenario[19,5]<-scenario[19,8]<-scenario[19,9]<-scenario[19,16]<-1 #i2/3/5/8/9/16 BHM + NPI + seas+ Delta variant+ NO vaccination + beh_resp increase  + IEvariant + additonal loss
scenario[20,2]<-scenario[20,3]<-scenario[20,5]<-scenario[20,8]<-scenario[20,9]<-scenario[20,10]<-scenario[20,15]<-scenario[20,16]<-scenario[20,20]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IV70 + IEvariant + BA4/5
scenario[21,2]<-scenario[21,3]<-scenario[21,5]<-scenario[21,8]<-scenario[21,9]<-scenario[21,16]<-scenario[21,20]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant + beh_resp increase + IEvariant + BA4/5
scenario[22,2]<-scenario[22,3]<-scenario[22,5]<-scenario[22,8]<-scenario[22,9]<-scenario[22,10]<-scenario[22,16]<-scenario[22,20]<-scenario[22,22]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IEvariant + BA4/5 + IV60
scenario[23,2]<-scenario[23,3]<-scenario[23,5]<-scenario[23,8]<-scenario[23,9]<-scenario[23,10]<-scenario[23,16]<-scenario[23,20]<-scenario[23,22]<-scenario[23,23]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IEvariant + BA4/5 + IV60 + HypIEvariant
scenario[24,2]<-scenario[24,3]<-scenario[24,5]<-scenario[24,8]<-scenario[24,9]<-scenario[24,10]<-scenario[24,16]<-scenario[24,20]<-scenario[24,22]<-scenario[24,23]<-scenario[24,24]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IEvariant + BA4/5 + IV60 + HypIEvariant + loss of severe protection
scenario[25,2]<-scenario[25,3]<-scenario[25,5]<-scenario[25,8]<-scenario[25,9]<-scenario[25,10]<-scenario[25,16]<-scenario[25,17]<-scenario[25,20]<-scenario[25,23]<-scenario[25,24]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase + IV90 + IEvariant + BA4/5 + HypIEvariant +  loss of severe protection
scenario[26,2]<-scenario[26,3]<-scenario[26,5]<-scenario[26,8]<-scenario[26,9]<-scenario[26,10]<-scenario[26,16]<-scenario[26,20]<-scenario[26,22]<-scenario[26,23]<-scenario[26,25]<-1 #i2/3/5/8/9/10/15/16/20 BHM + NPI + seas+ Delta variant+ vaccination + beh_resp increase  + IEvariant + BA4/5 + IV60 + HypIEvariant + partial loss of severe protection

colnames(scenario)<-c("i1", "i2", "i3", 'i4', "i5", "i6", "i7", "i8", "i9", "i10", "i11", "i12", "i13", "i14", "i15", "i16", "i17", "i18", "i19", "i20", "i21", "i22", "i23", "i24", "i25", "i26", "i27", "i28", "i29", "i30")

#### Run the Model ####
# Province Run formulation 

runprovmodel <-function(sc, pars){  #scenario number
  st<-Sys.time()
  intrun<-foreach(p=1:9) %dopar% {
    #Inputs for province p
    pars$ptsrun<-pars$pts[p]
    pars$pd1run<-pars$pd1prov[,p]
    pars$pd2run<-pars$pd2prov[,p]
    pars$r3run<-pars$r3[p]
    pars$r4run<-pars$r4[p]
    pars$ptrans0run<-pars$ptrans0[p]
    pars$contactrun<-con_all_prov[[p]]
    pars$cmNLseedsrun <- cmNLseeds[,c(1, (p+1))]; pars$hcwNLseedsrun <- hcwNLseeds[,c(1, (p+1))] ; pars$EENLseedsrun <- EENLseeds[,c(1, (p+1))]
    pars$cmdeltaseedsrun <- cmdeltaseeds[,c(1, (p+1))]; pars$hcwdeltaseedsrun <- hcwdeltaseeds[,c(1, (p+1))] ; pars$EEdeltaseedsrun <- EEdeltaseeds[,c(1, (p+1))]
    pars$cmievarseedsrun <- cmievarseeds[,c(1, (p+1))]; pars$hcwievarseedsrun <- hcwievarseeds[,c(1, (p+1))] ; pars$EEievarseedsrun <- EEievarseeds[,c(1, (p+1))]
    pars$cmba45varseedsrun <- cmba45varseeds[,c(1, (p+1))]; pars$hcwba45varseedsrun <- hcwba45varseeds[,c(1, (p+1))] ; pars$EEba45varseedsrun <- EEba45varseeds[,c(1, (p+1))]
    pars$cmhypIEvarseedsrun <- cmhypIEvarseeds[,c(1, (p+1))]; pars$hcwhypIEvarseedsrun <- hcwhypIEvarseeds[,c(1, (p+1))] ; pars$EEhypIEvarseedsrun <- EEhypIEvarseeds[,c(1, (p+1))]
    pars$NPIrun <- npi[,c(1,p+1)] 
    pars$beh_npirun <- beh_npi[,c(1,p+1)] 
    pars$delta_ccrun <-pars$delta_cc[p]
    pars$delta_dc1run <-pars$delta_dc1[p]
    pars$delta_dc2run <-pars$delta_dc2[p]
    pars$Cdelta_dc1run <-pars$Cdelta_dc1[p]
    pars$Cdelta_dc2run <-pars$Cdelta_dc2[p]
    pars$k_beh1run <- pars$k_beh1[p]
    pars$k_beh2run <- pars$k_beh2[p]
    pars$NLseedfacrun <-NLseedfac[p]
    pars$deltaseedfacrun <-deltaseedfac[p]
    pars$ievarseedfacrun <-ievarseedfac[p]
    pars$ba45varseedfacrun <-ba45varseedfac[p]
    pars$hypIEvarseedfacrun <-hypIEvarseedfac[p]
    pars$ievarstartrun <- ievarstart[p]
    #Vaccination
    pars$vproprun <- vacproc #%>% dplyr::filter(province==names(P)[p])
    pars$apprun <- app[[p]]
    pars$IV_P1datarun <- IV_P1data[[p]]
    pars$IV_P2datarun <- IV_P2data[[p]]
    pars$IV_Jdatarun <- IV_Jdata[[p]]
    pars$ivreq60run <- ivreq60[[p]]
    pars$ivreq60.4run <- ivreq60.4[[p]]
    pars$ivreq60.2run <- ivreq60.2[[p]]
    pars$ivreq70run <- ivreq70[[p]]
    pars$ivreq70.4run <- ivreq70.4[[p]]
    pars$ivreq70.2run <- ivreq70.2[[p]]
    pars$fvreq70run <- fvreq70[[p]]
    pars$ivreq90run <- ivreq90[[p]]
    pars$ivreq90.4run <- ivreq90.4[[p]]
    pars$ivreq90.2run <- ivreq90.2[[p]]
    pars$evds229_Jrun <- evds229_J %>% dplyr::filter(province==names(P)[p])
    pars$evds271_1run <- evds271_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds271_2run <- evds271_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds271_Jrun <- evds271_J %>% dplyr::filter(province==names(P)[p])
    pars$altrun <- alt %>% dplyr::filter(province==names(P)[p])
    pars$evds334_1run <- evds334_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds334_2run <- evds334_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds334_Jrun <- evds334_J %>% dplyr::filter(province==names(P)[p])
    pars$evds383_1run <- evds383_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds383_2run <- evds383_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds383_Jrun <- evds383_J %>% dplyr::filter(province==names(P)[p])
    pars$evds418_1run <- evds418_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds418_2run <- evds418_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds418_3run <- evds418_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds418_Jrun <- evds418_J %>% dplyr::filter(province==names(P)[p])
    pars$evds418_J2run <- evds418_J2 %>% dplyr::filter(province==names(P)[p])
    pars$evds446_1run <- evds446_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds446_2run <- evds446_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds446_3run <- evds446_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds446_Jrun <- evds446_J %>% dplyr::filter(province==names(P)[p])
    pars$evds446_J2run <- evds446_J2 %>% dplyr::filter(province==names(P)[p])
    pars$evds523_1run <- evds523_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds523_2run <- evds523_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds523_3run <- evds523_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds523_Jrun <- evds523_J %>% dplyr::filter(province==names(P)[p])
    pars$evds523_J2run <- evds523_J2 %>% dplyr::filter(province==names(P)[p])
    pars$evds558_1run <- evds558_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds558_2run <- evds558_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds558_3run <- evds558_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds558_Jrun <- evds558_J %>% dplyr::filter(province==names(P)[p])
    pars$evds558_J2run <- evds558_J2 %>% dplyr::filter(province==names(P)[p])
    pars$evds607_1run <- evds607_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds607_2run <- evds607_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds607_3run <- evds607_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds607_Jrun <- evds607_J %>% dplyr::filter(province==names(P)[p])
    pars$evds607_J2run <- evds607_J2 %>% dplyr::filter(province==names(P)[p])

    pars$evds823_1run <- evds823_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds823_2run <- evds823_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds823_3run <- evds823_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds823_Jrun <- evds823_J %>% dplyr::filter(province==names(P)[p])
    pars$evds823_J2run <- evds823_J2 %>% dplyr::filter(province==names(P)[p])
    pars$evds881_1run <- evds881_1 %>% dplyr::filter(province==names(P)[p])
    pars$evds881_2run <- evds881_2 %>% dplyr::filter(province==names(P)[p])
    pars$evds881_3run <- evds881_3 %>% dplyr::filter(province==names(P)[p])
    pars$evds881_Jrun <- evds881_J %>% dplyr::filter(province==names(P)[p])
    pars$evds881_J2run <- evds881_J2 %>% dplyr::filter(province==names(P)[p])
    
     #Inputs for age group
    pars$pss1 <- pars$pss_scale*pars$pss1_ratio #WILD: proportion severe/critical among symptomatic infections
    pars$pss2 <- pars$pss_scale*pars$pss2_ratio #NL: proportion severe/critical among symptomatic infections
    pars$psr <- pars$psr_scale*pars$psr_ratio #proportion severe/critical among symptomatic infections for previously infected
    
    #scenario toggles
    pars$beh_decrun <-beh_dec[p]
    pars$beh_dec_startrun <- beh_dec_start[p]
    pars$beh_dec_stoprun <- beh_dec_stop[p]
    pars$beh_dec_start2 <-beh_dec_start2
    run(pars, scenario[sc,], p)
  }

  names(intrun)<-names(P)
  out <- rbindlist(intrun, use.names = T, idcol=T);names(out)[1]<-"province"
  outprov <- out %>% group_by(province, variable, day) %>%  summarise(value = sum(value)) %>%  ungroup() %>% mutate(age = 100, subpop = 0)
  outage <- out %>% group_by(age, variable, day) %>%  summarise(value = sum(value)) %>%  ungroup() %>% mutate(province = "SA", subpop = 0)
  outsubpop <- out %>% group_by(subpop, variable, day) %>%  summarise(value = sum(value)) %>%  ungroup() %>% mutate(province = "SA", age = 100)
  outprovage <- out %>% group_by(province, age, variable, day) %>%  summarise(value = sum(value)) %>%  ungroup() %>% mutate(subpop = 0)
  outSA <- out %>% group_by(subpop,age, variable, day) %>%  summarise(value = sum(value)) %>%  ungroup() %>% mutate(province = "SA")
  outall <- out %>% group_by(variable, day) %>%  summarise(value = sum(value)) %>%  ungroup() %>% mutate(province = "SA", age = 100, subpop = 0)
  df<-rbind(out, outprov, outage, outsubpop,outprovage, outSA, outall)
  en<-Sys.time()
  return(df)
} 
time <-data.frame(day = 1:(tyears/dtout +1), time = seq(startdate, startdate+tyears/dtout, 1))


#Province specific parameters 
pars$pts<-provparam$pts
pars$r3<-provparam$r3
pars$r4<-provparam$r4
pars$pd1prov <- matrix(rep(pars$pd1SA, length(P)), ncol = length(P), byrow = F)
pars$pd2prov <- matrix(rep(pars$pd2SA, length(P)), ncol = length(P), byrow = F)
#Death adjusters per province
pars$pd1prov[,1]<-1.35*pars$pd1prov[,1]; pars$pd2prov[,1]<-1.35*pars$pd2prov[,1]
pars$pd1prov[,4]<-1.3*pars$pd1prov[,4]; pars$pd2prov[,4]<-1.2*pars$pd2prov[,4]
pars$pd1prov[,5]<-1.75*pars$pd1prov[,5]; pars$pd2prov[,5]<-1.2*pars$pd2prov[,5]
pars$pd1prov[,6]<-1.75*pars$pd1prov[,6]; pars$pd2prov[,6]<-1.2*pars$pd2prov[,6]
if(sum(pars$pd1prov>1)>1) {stop("Probability greater than 1!")} 
if(sum(pars$pd2prov >1)>1) {stop("Probability greater than 1!")} 


#Toggles for visual calibration
pars$pss_scale <- 0.06
pars$psr_scale <- 0.06
if(sum(pars$pss_scale*pars$pss1_ratio >1)>1) {stop("Probability greater than 1!")} 
if(sum(pars$pss_scale*pars$pss2_ratio >1)>1) {stop("Probability greater than 1!")} 
if(sum(pars$psr_scale*pars$psr_ratio >1)>1) {stop("Probability greater than 1!")}
pars$ptrans0<-1.1*c(1.3, 1, 1.1, 1.5, 1.1, 1.2, 0.7, 0.85, 0.8 ) # WC = 0.875 start with wild type pre wave 2
pars$susRcross <-pars$susR<-0.01
pars$transNL<-1.2*2.5
pars$delta_dc1<-0.9*c(300, 40, 350, 20000, 350, 200, 15, 60, 250) #NC 15 # pre 1 April to generate Wave 2 WC= 280, NC =15
pars$delta_dc2<-0.9*c(90, 25, 350, 2500, 100, 60, 10, 60, 100) #now #250 low KZN
pars$Cdelta_dc1<-1*c(15000, 6000, 19000,	12000,	5000,	4500,	9000, 5800,	10500) # wC uw 12500
pars$Cdelta_dc2<-1*c(12500, 7000, 19000,	9000,	5500,	4800,	9000, 6500,	9500) # KZN low 12500
pars$delta_cc<-2*c(1500, 2000, 3000, 4000, 1500, 1500, 1000, 3000, 2500)
pars$k_beh1<- c(1, 4.5, 3,	2, 1.25,	1.25, 6,	3, 5) # better fit 28/09 
pars$k_beh2<- c(1, 6, 1.5,	1.05, 1.5,	1.15, 2,	2, 1) # #2.5 low KZN ; 1.15

#scenarios :
NPIstop<-183 #  Stop Gmobilities NPI 183 1 April; 244 1 June ; 285 12 July
beh_dec_start <-c(183, 183, 183, 150, 183, 183, 198, 208, 183) #starting point for decrease in behaivour change
beh_dec <-1.1*c(1.2, 1.35, 1.35, 1.4, 1.8, 1.65, 1.5, 1.4,  1.5) # applied to beh_dec_start scale factor to apply to Beh threshold (>1 -> decreased response to mortality)

beh_dec_stop <-rep(411,9) #stopping point for decrease in behaivour change (1 Nov)
beh_dec_start2 <-411
beh_scen <-1
beh_scen*beh_dec

# Variants
#transmission switchovers
deltastart <- 183 # Apply WT to Delta parameter switch over 1 April 21
deltatranscale<- 3.5*pars$transNL #transmission scale factor for delta 
susDeltacross <- 1*pars$susRcross #only lab evidence of increased reinfection; not data-evidence
ievarstart <- c(357,380,346,361,350,366,392,366,357) # Immune escape variant parameter switch over from Beta on 15 September 21
pars$sevReinRed<-pars$sevP_2 #severity scale reduction factor for reinfection == 2 Pfizer dose 
ba45varstart <- 489 # Apply Delta to BA4/5 parameter switch over 1 Feb 22
susBA45cross <- 1*pars$susRcross #changes with escape
hypIEvarstart <- 1096 # Apply parameter switch over 1 Oct 23

#Seed scaling 
seedfac<-100  #case seed inflation factor 
#NLseedfac<-rep(4000, length(P)); NLseedfac[1]<-80000; NLseedfac[9]<-20000 # New lineage/Beta case seed fac
NLseedfac<-rep(4000, length(P)); NLseedfac[1]<-350000; NLseedfac[9]<-20000 # New lineage/Beta case seed fac
deltaseedfac<-rep(10000, length(P))#;deltaseedfac[4]<-10000; deltaseedfac[6]<-10000; deltaseedfac[1]<-10000; deltaseedfac[2]<-10000; deltaseedfac[8]<-10000 # Delta case seed fac
ievarseedfac<-0.001*rep(10000, length(P)) #immune escape variant seedfac
ba45varseedfac<-1*rep(10000, length(P)) #immune escape variant seedfac
hypIEvarseedfac<-0.001*rep(10000, length(P)) #immune escape variant seedfac


#LOS adjustments 
LOSpr3<-provparam$r3
LOSpr4<-provparam$r4

LOSpr3[1]<-LOSpr3[1]/1.5; LOSpr3[3]<-LOSpr3[3]/1.5; LOSpr3[4]<-LOSpr3[4]/1.5; LOSpr3[9]<-LOSpr3[9]/1.5
LOSpr4[3]<-LOSpr4[3]/1.8;
pars$r3<-LOSpr3
pars$r4<-LOSpr4

#Immune escape parameters
pars$escape=0.5
pars$sev_escfac =0.05
pars$sev_escP1_b =0.10 #min 8%
pars$sev_escP2_b =0.10 #min 3% 
pars$sev_escJ_b =0.25 #min 17%
pars$Otrans = 1.75 
pars$loss = 0 #trigger to allow for loss of protection from previously protected and infected PRs
pars$escapeBA45scale = 1.5
pars$escapehypIEscale = 1 #omicron like (IE against Removed and vaccine not protected and faster waning)
doParallel::registerDoParallel(16)  # register your cores

#Omicron decrease virulence parameters
pars$Osevdec=0.75



#### Run once ####
st<-Sys.time(); df<-runprovmodel(sc=1, pars); en<-Sys.time(); en-st

